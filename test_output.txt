
> claudiomiro@2.5.0 test
> npx jest --testPathIgnorePatterns='dag-executor.test.js|cli.test.js'

FAIL src/commands/task-executor/steps/step7/index.test.js
  step7
    Skip Conditions
      ✓ should skip if CRITICAL_REVIEW_PASSED.md already exists (3 ms)
      ✓ should skip if newbranch.txt does not exist (not Claudiomiro branch) (1 ms)
      ✓ should skip if AI_PROMPT.md does not exist (incomplete session) (1 ms)
      ✓ should skip if no code changes detected (git status clean + no commits)
      ✓ should skip if not a git repository (git commands fail) (1 ms)
    Git Operations
      ✓ should proceed when git status shows uncommitted changes (1 ms)
      ✓ should proceed when git status is clean but commits exist
      ✓ should handle repository with no commits correctly
      ✓ should handle git command failures gracefully (1 ms)
    fix-branch Delegation
      ✕ should call fix-branch with default iterations (20) and level 2 (2 ms)
      ✕ should call fix-branch with custom max iterations (1 ms)
      ✕ should call fix-branch with --no-limit when maxIterations is Infinity
      ✓ should always pass --no-clear to fix-branch
      ✓ should log starting message with branch info (1 ms)
      ✓ should log success when fix-branch completes
    Error Handling
      ✓ should throw error when state.claudiomiroFolder is undefined (2 ms)
      ✓ should propagate fix-branch errors
    Edge Cases
      ✓ should handle branch name being undefined
      ✕ should use default maxIterations (20) when not provided (1 ms)
    Integration Verification
      ✓ should skip integration verification in single-repo mode
      ✓ should run integration verification in multi-repo mode
      ✓ should throw error when integration verification fails
      ✓ should format multiple mismatches in error message (1 ms)
      ✓ should include fix instruction in error message
      ✓ should call integration verification after fix-branch in step7
      ✓ should fail step7 when integration verification fails
      ✓ should not run integration verification when step7 skips for existing passed file (1 ms)
      ✓ should use state.getRepository to get paths

  ● step7 › fix-branch Delegation › should call fix-branch with default iterations (20) and level 2

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--limit=20",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      263 |             await step7();
      264 |
    > 265 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      266 |                 '--limit=20',
      267 |                 '--level=2',
      268 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:265:34)

  ● step7 › fix-branch Delegation › should call fix-branch with custom max iterations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--limit=10",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      284 |             await step7(10);
      285 |
    > 286 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      287 |                 '--limit=10',
      288 |                 '--level=2',
      289 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:286:34)

  ● step7 › fix-branch Delegation › should call fix-branch with --no-limit when maxIterations is Infinity

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--no-limit",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      304 |             await step7(Infinity);
      305 |
    > 306 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      307 |                 '--no-limit',
      308 |                 '--level=2',
      309 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:306:34)

  ● step7 › Edge Cases › should use default maxIterations (20) when not provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--limit=20",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      416 |             await step7(); // No maxIterations provided
      417 |
    > 418 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      419 |                 '--limit=20',
      420 |                 '--level=2',
      421 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:418:34)

FAIL src/commands/loop-fixes/executor.test.js
  src/commands/loop-fixes/executor.js
    countPendingItems()
      ✓ should return 0 when file does not exist (3 ms)
      ✓ should return 0 when file is empty (1 ms)
      ✓ should count pending items correctly
      ✓ should return 0 when all items are completed
      ✓ should handle read errors gracefully (1 ms)
    countCompletedItems()
      ✓ should return 0 when file does not exist
      ✓ should count completed items correctly
      ✓ should handle case-insensitive [X] markers
    initializeFolder()
      ✓ should create .claudiomiro folder if it does not exist
      ✓ should not create folder if it already exists
      ✓ should call state.setFolder if claudiomiroFolder is not defined (1 ms)
    loopFixes()
      ✓ should throw error when prompt is empty (12 ms)
      ✓ should throw error when prompt is null (1 ms)
      ✓ should throw error when prompt is only whitespace
      ✓ should throw error when prompt.md is not found
      ✓ should throw error when verification-prompt.md is not found (1 ms)
      ✓ should complete successfully after verification passes (CRITICAL_REVIEW_OVERVIEW.md + CRITICAL_REVIEW_PASSED.md)
      ✓ should continue loop when verification finds new tasks (2 ms)
      ✓ should iterate multiple times until CRITICAL_REVIEW_OVERVIEW.md is created then verify (1 ms)
      ✓ should throw error when max iterations reached without completion
      ✓ should throw error when max iterations reached during verification (1 ms)
      ✓ should handle Claude execution failure
      ✓ should replace placeholders in prompt template
      ✓ should replace placeholders in verification prompt template
      ✓ should handle unlimited iterations (Infinity) (1 ms)
      ✓ should log iteration progress
      ✓ should log summary when issues were fixed
      ✓ should truncate long prompts in log output
      ✓ should display pending and completed counts during iteration (1 ms)
      ✕ should delete CRITICAL_REVIEW_OVERVIEW.md when entering verification mode

  ● src/commands/loop-fixes/executor.js › loopFixes() › should delete CRITICAL_REVIEW_OVERVIEW.md when entering verification mode

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "CRITICAL_REVIEW_OVERVIEW.md"

    Number of calls: 0

      750 |             await loopFixes('Test prompt', 10);
      751 |
    > 752 |             expect(fs.unlinkSync).toHaveBeenCalledWith(expect.stringContaining('CRITICAL_REVIEW_OVERVIEW.md'));
          |                                   ^
      753 |             expect(logger.info).toHaveBeenCalledWith(expect.stringContaining('Starting verification'));
      754 |         });
      755 |     });

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/executor.test.js:752:35)

FAIL src/commands/loop-fixes/index.test.js
  src/commands/loop-fixes/index.js
    parsePromptArg()
      ✓ should return null when --prompt= is not provided
      ✓ should parse simple prompt (1 ms)
      ✓ should handle prompt with double quotes
      ✓ should handle prompt with single quotes
      ✓ should handle prompt with equals sign
      ✓ should handle prompt with multiple equals signs
      ✓ should return null for empty prompt value
    run()
      ✓ should log "Running loop-fixes" with iteration limit
      ✕ should parse --limit=5 correctly (1 ms)
      ✕ should default maxIterations to 20 when no limit flag (1 ms)
      ✕ should show "no limit" when --no-limit is passed
      ✓ should set folder from args
      ✓ should default folder to process.cwd() when not provided
      ✕ should handle multiple flags correctly
      ✕ should call loopFixes with parsed prompt
      ✕ should use interactive input when --prompt= is not provided
      ✓ should throw error when no prompt is provided and interactive input is empty (2 ms)
      ✓ should throw error when no prompt is provided and interactive input is whitespace
      ✕ should handle prompt with special characters (1 ms)
      ✕ should handle prompt with newlines (from shell escaping)
    exports
      ✓ should export run function
      ✓ should export parsePromptArg function (1 ms)

  ● src/commands/loop-fixes/index.js › run() › should parse --limit=5 correctly

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test prompt", 5
    Received: "Test prompt", 5, {"freshStart": true}

    Number of calls: 1

      107 |
      108 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: 5)');
    > 109 |             expect(loopFixes).toHaveBeenCalledWith('Test prompt', 5);
          |                               ^
      110 |         });
      111 |
      112 |         test('should default maxIterations to 20 when no limit flag', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:109:31)

  ● src/commands/loop-fixes/index.js › run() › should default maxIterations to 20 when no limit flag

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test prompt", 20
    Received: "Test prompt", 20, {"freshStart": true}

    Number of calls: 1

      116 |
      117 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: 20)');
    > 118 |             expect(loopFixes).toHaveBeenCalledWith('Test prompt', 20);
          |                               ^
      119 |         });
      120 |
      121 |         test('should show "no limit" when --no-limit is passed', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:118:31)

  ● src/commands/loop-fixes/index.js › run() › should show "no limit" when --no-limit is passed

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test prompt", Infinity
    Received: "Test prompt", Infinity, {"freshStart": true}

    Number of calls: 1

      125 |
      126 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: no limit)');
    > 127 |             expect(loopFixes).toHaveBeenCalledWith('Test prompt', Infinity);
          |                               ^
      128 |         });
      129 |
      130 |         test('should set folder from args', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:127:31)

  ● src/commands/loop-fixes/index.js › run() › should handle multiple flags correctly

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test", Infinity
    Received: "Test", Infinity, {"freshStart": true}

    Number of calls: 1

      152 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: no limit)');
      153 |             expect(state.setFolder).toHaveBeenCalledWith('/some/path');
    > 154 |             expect(loopFixes).toHaveBeenCalledWith('Test', Infinity);
          |                               ^
      155 |         });
      156 |
      157 |         test('should call loopFixes with parsed prompt', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:154:31)

  ● src/commands/loop-fixes/index.js › run() › should call loopFixes with parsed prompt

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Check for inconsistencies", 20
    Received: "Check for inconsistencies", 20, {"freshStart": true}

    Number of calls: 1

      160 |             await run(args);
      161 |
    > 162 |             expect(loopFixes).toHaveBeenCalledWith('Check for inconsistencies', 20);
          |                               ^
      163 |         });
      164 |
      165 |         test('should use interactive input when --prompt= is not provided', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:162:31)

  ● src/commands/loop-fixes/index.js › run() › should use interactive input when --prompt= is not provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Interactive user prompt", 20
    Received: "Interactive user prompt", 20, {"freshStart": true}

    Number of calls: 1

      171 |             expect(logger.info).toHaveBeenCalledWith('No --prompt= provided. Please enter your prompt:');
      172 |             expect(getMultilineInput).toHaveBeenCalled();
    > 173 |             expect(loopFixes).toHaveBeenCalledWith('Interactive user prompt', 20);
          |                               ^
      174 |         });
      175 |
      176 |         test('should throw error when no prompt is provided and interactive input is empty', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:173:31)

  ● src/commands/loop-fixes/index.js › run() › should handle prompt with special characters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Check for $pecial & <characters>", 20
    Received: "Check for $pecial & <characters>", 20, {"freshStart": true}

    Number of calls: 1

      195 |             await run(args);
      196 |
    > 197 |             expect(loopFixes).toHaveBeenCalledWith('Check for $pecial & <characters>', 20);
          |                               ^
      198 |         });
      199 |
      200 |         test('should handle prompt with newlines (from shell escaping)', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:197:31)

  ● src/commands/loop-fixes/index.js › run() › should handle prompt with newlines (from shell escaping)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Line1\\nLine2", 20
    Received: "Line1\\nLine2", 20, {"freshStart": true}

    Number of calls: 1

      203 |             await run(args);
      204 |
    > 205 |             expect(loopFixes).toHaveBeenCalledWith('Line1\\nLine2', 20);
          |                               ^
      206 |         });
      207 |     });
      208 |

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:205:31)

PASS src/commands/task-executor/services/file-manager.test.js
  file-manager
    startFresh()
      with existing folder + createFolder=false
        ✓ should remove existing folder without recreating it (1 ms)
        ✓ should call logger methods in correct order
      with existing folder + createFolder=true
        ✓ should remove existing folder and recreate it
        ✓ should call both rmSync and mkdirSync
        ✓ should call logger methods in correct order (1 ms)
      when folder does not exist
        ✓ should not remove folder and should not create it when createFolder=false
        ✓ should create folder when createFolder=true
        ✓ should call logger methods in correct order when createFolder=false (1 ms)
        ✓ should call logger methods in correct order when createFolder=true
      insights preservation
        ✓ should backup and restore insights folder when present
      error handling scenarios
        ✓ should propagate error when fs.existsSync throws (13 ms)
        ✓ should propagate error when fs.rmSync throws
        ✓ should propagate error when fs.mkdirSync throws (4 ms)
        ✓ should propagate error when mkdirSync throws and folder does not exist
      logger integration
        ✓ should call task() at the beginning
        ✓ should call indent() after task()
        ✓ should call success() after rmSync when folder exists (1 ms)
        ✓ should call outdent() at the end
        ✓ should verify correct message format in success()
        ✓ should call all logger methods in proper sequence for full flow
      file system error scenarios
        permission errors during folder removal
          ✓ should handle EACCES permission denied during rmSync
          ✓ should handle EPERM operation not permitted during rmSync (1 ms)
        permission errors during folder creation
          ✓ should handle EACCES permission denied during mkdirSync
          ✓ should handle EPERM operation not permitted during mkdirSync
          ✓ should handle ENOSPC no space left on device during mkdirSync (1 ms)
          ✓ should handle ENOENT parent directory does not exist during mkdirSync
        disk space and device errors
          ✓ should handle ENOSPC during folder removal (disk full)
          ✓ should handle EIO input/output error during file operations
        invalid path handling
          ✓ should handle invalid folder path during existsSync (1 ms)
          ✓ should handle ENAMETOOLONG path too long error
        concurrent access and race conditions
          ✓ should handle EBUSY resource busy during rmSync
          ✓ should handle ETIMEDOUT operation timed out during rmSync
      directory management edge cases
        nested directory scenarios
          ✓ should handle deeply nested directory paths during removal
          ✓ should handle deeply nested directory paths during creation (1 ms)
          ✓ should remove and recreate deeply nested directories
        special directory names
          ✓ should handle directory names with spaces
          ✓ should handle directory names with special characters
          ✓ should handle unicode directory names
          ✓ should handle emoji in directory names
        very long directory names
          ✓ should handle long directory names within limits
          ✓ should handle extremely long but valid paths
        edge case path patterns
          ✓ should handle paths ending with dots
          ✓ should handle paths with multiple consecutive slashes
          ✓ should handle paths with trailing slash
        system-specific path scenarios
          ✓ should handle Windows-style paths on Windows systems
          ✓ should handle relative paths
          ✓ should handle parent directory references
        directory cleanup simulation
          ✓ should simulate cleanup of directory with mixed content
          ✓ should handle cleanup of empty directory
      backup and restore functionality
        backup creation scenarios
          ✓ should create backup before removing existing directory
          ✓ should handle backup creation failure gracefully
          ✓ should create timestamped backup directories
        backup version management
          ✓ should handle multiple backup versions
          ✓ should clean up old backups when exceeding limit (1 ms)
          ✓ should preserve backup retention policy
        restore functionality
          ✓ should prepare for restore operation logging
          ✓ should handle restore from latest backup
          ✓ should validate backup integrity before restore
        backup storage management
          ✓ should handle backup storage space management
          ✓ should compress large backups when configured
          ✓ should handle backup path conflicts
        backup logging and observability
          ✓ should log backup creation process
          ✓ should report backup operation status
      file existence validation
        basic file existence scenarios
          ✓ should handle directory existence validation
          ✓ should handle non-existent directory validation
          ✓ should handle file instead of directory scenario
        symbolic link handling
          ✓ should handle valid symbolic links (2 ms)
          ✓ should handle broken symbolic links (1 ms)
          ✓ should handle symbolic link loops
        file accessibility validation
          ✓ should handle read-only directories
          ✓ should handle directories with restricted permissions
          ✓ should handle directories owned by different users (1 ms)
        file integrity and validation
          ✓ should handle corrupted directory structures
          ✓ should handle directories with invalid entries
          ✓ should handle directories with locked files
        special file system scenarios
          ✓ should handle network file system paths
          ✓ should handle virtual file system paths (1 ms)
          ✓ should handle temporary file system paths
        path traversal and security validation
          ✓ should handle path traversal attempts in validation
          ✓ should handle null byte injection attempts
          ✓ should handle extremely long path traversal
        concurrent access validation
          ✓ should handle directory modified during operation
          ✓ should handle directory locked by another process
        validation error handling
          ✓ should handle validation system errors gracefully
          ✓ should handle validation timeout scenarios (1 ms)

PASS src/index.test.js
  src/index.js
    parseArgs()
      ✓ should route to task-executor when no special flags are present (46 ms)
      ✓ should route to fix-command when --fix-command flag is present (6 ms)
      ✓ should route to loop-fixes when --loop-fixes flag is present (5 ms)
      ✓ should give --fix-command precedence over --loop-fixes (4 ms)
    init()
      ✓ should call logger.banner() first (7 ms)
      ✓ should call checkForUpdatesAsync with "claudiomiro" (6 ms)
      ✓ should pass all args to the command module (9 ms)
      ✓ should handle empty args (defaults to task-executor) (8 ms)
      ✓ should skip banner for token-optimizer without --verbose (5 ms)
      ✓ should show banner for token-optimizer with --verbose (11 ms)
    exports
      ✓ should export init function

PASS src/shared/executors/gemini-executor.test.js
  Gemini Executor
    executeGemini
      ✓ should throw error when no prompt provided (6 ms)
      ✓ should create temporary file with prompt text (5 ms)
      ✓ should spawn Gemini process with correct command (1 ms)
      ✓ should handle stdout data processing (1 ms)
      ✓ should handle process close with success code (1 ms)
      ✓ should handle process close with error code (1 ms)
      ✓ should handle process error (1 ms)
      ✓ should update state manager when taskName provided (1 ms)
      ✓ should cleanup temporary file on successful completion (1 ms)
      ✓ should suppress streaming logs when UI renderer is active (1 ms)

PASS src/commands/task-executor/steps/step6/index.test.js
  step6
    orchestration flow
      ✓ should call reviewCode and return result (1 ms)
      ✓ should call smartCommit when TODO is fully implemented
      ✓ should call smartCommit without push when shouldPush is false (1 ms)
      ✓ should not call smartCommit when TODO is not fully implemented
    commit error handling
      ✓ should continue execution when commit fails
      ✓ should not warn when commit succeeds
    re-analysis logic
      ✓ should call reanalyzeFailed on 3rd attempt when TODO not implemented
      ✓ should call reanalyzeFailed on 6th attempt when TODO not implemented
      ✓ should not call reanalyzeFailed on 1st attempt when TODO not implemented (1 ms)
      ✓ should not call reanalyzeFailed on 2nd attempt when TODO not implemented
      ✓ should not call reanalyzeFailed on 4th attempt when TODO not implemented
      ✓ should not call reanalyzeFailed when TODO is implemented regardless of attempts
      ✓ should not call reanalyzeFailed when info.json does not exist
      ✓ should handle JSON parsing error gracefully (6 ms)
    edge cases
      ✓ should handle zero attempt count (1 ms)
      ✓ should handle negative attempt count
    default parameters
      ✓ should use shouldPush=true by default
    multi-repo commit scenarios
      ✓ should commit normally in single-repo mode (backward compatible)
      ✓ should create single commit in monorepo mode
      ✓ should commit to backend repo only for backend scope
      ✓ should commit to frontend repo only for frontend scope
      ✓ should commit to backend then frontend for integration scope
      ✓ should call validateScope in multi-repo mode
      ✓ should pass correct cwd to smartCommit for backend scope
      ✓ should pass correct cwd to smartCommit for frontend scope (1 ms)

  console.warn
    Unknown task name: non-existent-task

      73 |         if (!taskState) {
      74 |             // Gracefully handle unknown tasks
    > 75 |             console.warn(`Unknown task name: ${taskName}`);
         |                     ^
      76 |             return;
      77 |         }
      78 |

      at ParallelStateManager.warn [as updateTaskStatus] (src/shared/executors/parallel-state-manager.js:75:21)
      at updateTaskStatus (src/shared/executors/parallel-state-manager.test.js:706:33)
      at callTimer (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:744:24)
      at doTickInner (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1312:29)
      at doTick (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1393:20)
      at Object.tick (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1401:20)
      at FakeTimers.advanceTimersByTime (node_modules/@jest/fake-timers/build/modernFakeTimers.js:94:19)
      at Object.advanceTimersByTime (src/shared/executors/parallel-state-manager.test.js:713:18)

  console.warn
    Unknown task name: unknown-task

      73 |         if (!taskState) {
      74 |             // Gracefully handle unknown tasks
    > 75 |             console.warn(`Unknown task name: ${taskName}`);
         |                     ^
      76 |             return;
      77 |         }
      78 |

      at ParallelStateManager.warn [as updateTaskStatus] (src/shared/executors/parallel-state-manager.js:75:21)
      at updateTaskStatus (src/shared/executors/parallel-state-manager.test.js:1041:33)
      at callTimer (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:744:24)
      at doTickInner (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1312:29)
      at doTick (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1393:20)
      at Object.tick (node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1401:20)
      at FakeTimers.advanceTimersByTime (node_modules/@jest/fake-timers/build/modernFakeTimers.js:94:19)
      at Object.advanceTimersByTime (src/shared/executors/parallel-state-manager.test.js:1055:18)

PASS src/shared/executors/parallel-state-manager.test.js
  ParallelStateManager
    Singleton Pattern
      ✓ should return the same instance (1 ms)
      ✓ should maintain state across instances
    initialize
      ✓ should initialize with empty array (1 ms)
      ✓ should initialize with single task
      ✓ should initialize with multiple tasks
      ✓ should clear previous state on re-initialization
      ✓ should initialize from object preserving status
      ✓ should throw error for invalid input (11 ms)
    updateTaskStatus
      ✓ should update to pending
      ✓ should update to running
      ✓ should update to completed
      ✓ should update to failed
      ✓ should throw error for invalid status (1 ms)
      ✓ should handle unknown task name gracefully
      ✓ should allow multiple status transitions
    updateTaskStep
      ✓ should update step with string value
      ✓ should update step with null value (1 ms)
      ✓ should update step with undefined value
      ✓ should handle unknown task name gracefully
      ✓ should allow multiple step updates
    updateClaudeMessage
      ✓ should store message under 100 characters
      ✓ should store message exactly 100 characters
      ✓ should truncate message over 100 characters
      ✓ should truncate long message with meaningful text
      ✓ should handle null message
      ✓ should handle undefined message
      ✓ should handle empty string (1 ms)
      ✓ should handle unknown task name gracefully
      ✓ should allow multiple message updates
    UI renderer state
      ✓ should toggle UI renderer active flag
      ✓ should coerce non-boolean values when toggling
    getAllTaskStates
      ✓ should return empty object for uninitialized manager
      ✓ should return all task states
      ✓ should return correct state format
      ✓ should return updated states (1 ms)
      ✓ should not expose internal state Map
    Edge Cases and Error Handling
      ✓ should not crash on null task name in updateTaskStatus
      ✓ should not crash on null task name in updateTaskStep
      ✓ should not crash on null task name in updateClaudeMessage
      ✓ should handle concurrent updates simulation
      ✓ should handle special characters in messages
      ✓ should handle unicode characters in messages
      ✓ should maintain state integrity across multiple operations (1 ms)
    Integration Scenarios
      ✓ should handle full task lifecycle
      ✓ should handle multiple parallel tasks
    Advanced Concurrency Scenarios
      ✓ should handle true concurrent access with Promise.all() and varied delays (2 ms)
      ✓ should maintain state consistency under high-frequency concurrent updates (9 ms)
      ✓ should handle singleton pattern race conditions with concurrent instantiation (1 ms)
      ✓ should validate state invariants under concurrent mixed operations (25 ms)
      ✓ should handle rapid re-initialization under concurrent access (1 ms)
      ✓ should ensure atomic state operations under concurrent stress (7 ms)
    Performance Regression Tests
      ✓ should handle 100+ concurrent state updates within timing targets (4 ms)
      ✓ should maintain memory efficiency for large task sets (4 ms)
    Integration with ParallelUIRenderer
      ✓ should coordinate UI renderer lifecycle with state changes (1 ms)
      ✓ should handle UI renderer activation with state synchronization
      ✓ should handle error recovery scenarios with UI coordination (2 ms)

  console.warn
    ast-grep not available, using basic regex indexing: A dynamic import callback was invoked without --experimental-vm-modules

      26 |     } catch (error) {
      27 |     // ast-grep not available, will use fallback
    > 28 |         console.warn('ast-grep not available, using basic regex indexing:', error.message);
         |                 ^
      29 |         astGrepAvailable = false;
      30 |         return null;
      31 |     }

      at warn (src/shared/services/code-index/index-builder.js:28:17)
      at IndexBuilder.scan (src/shared/services/code-index/index-builder.js:267:9)
      at CodeIndex.build (src/shared/services/code-index/index.js:61:26)
      at getRelevantSymbols (src/shared/services/context-cache/context-collector.js:627:13)
      at Object.<anonymous> (src/shared/services/context-cache/context-collector.test.js:544:28)

PASS src/shared/services/context-cache/context-collector.test.js
  context-collector
    getTaskOrder
      ✓ should return numeric order for simple task (1 ms)
      ✓ should handle subtask notation
      ✓ should return 0 for invalid format
    getTaskFolders
      ✓ should return empty array if folder does not exist
      ✓ should return sorted task folders
    isTaskCompleted
      ✓ should return false if TODO.md does not exist
      ✓ should return true if TODO starts with "Fully implemented: YES" (1 ms)
      ✓ should return false if TODO starts with "Fully implemented: NO"
    extractContextSummary
      ✓ should return null if file does not exist
      ✓ should extract files modified and decisions
    extractContextSummaryAsync (with fallback)
      ✓ should return null if file does not exist
      ✓ should fallback to heuristic extraction when Ollama unavailable (7 ms)
      ✓ should include fullPath in result
    extractResearchPatterns
      ✓ should return null if file does not exist
      ✓ should extract strategy, patterns, and topics
    extractResearchPatternsAsync (with fallback)
      ✓ should return null if file does not exist
      ✓ should fallback to heuristic extraction when Ollama unavailable (1 ms)
      ✓ should detect extended keyword list
      ✓ should include fullPath in result
    createAiPromptSummary
      ✓ should return empty string if file does not exist
      ✓ should extract tech stack, architecture, and conventions (2 ms)
      ✓ should return first 1500 chars if no sections found (1 ms)
    extractCodebasePatterns
      ✓ should detect Jest testing framework
      ✓ should detect Python pytest framework
      ✓ should detect CommonJS import style
      ✓ should detect ESM import style (1 ms)
      ✓ should detect test file naming convention
      ✓ should detect primary language from file extensions
      ✓ should detect key directories
      ✓ should detect functional code style
      ✓ should return empty object for empty content
    getIncrementalContext
      ✓ should return AI prompt summary from cache if valid
      ✓ should generate new summary if AI prompt changed (1 ms)
      ✓ should exclude current task from context
    buildConsolidatedContext
      ✓ should build context string with all sections
    markTaskCompleted
      ✓ should add task to cache with summary
    getContextFilePaths
      ✓ should return context file paths for completed tasks
      ✓ should exclude incomplete tasks when onlyCompleted is true
    getRelevantSymbols (with semantic search)
      ✓ should return null when code index is not available (47 ms)
      ✓ should accept options for maxSymbols and kinds
      ✓ should accept useSemantic option
      ✓ should fallback to keyword search when useSemantic is false
    getFileSummary
      ✓ should return null when code index is not available
    buildConsolidatedContextAsync
      ✓ should return base context when no project folder provided
      ✓ should include base context even when symbols not available

PASS src/shared/services/code-index/index.test.js
  CodeIndex
    IndexBuilder
      ✓ should scan directory and find JavaScript files (6 ms)
      ✓ should ignore node_modules directory (1 ms)
      ✓ should extract function declarations (1 ms)
      ✓ should extract class declarations
      ✓ should detect exported symbols (1 ms)
      ✓ should calculate file hashes (1 ms)
      ✓ should handle TypeScript files
      ✓ should handle empty directory (1 ms)
      ✓ should respect maxFileSize option (1 ms)
      ✓ should perform incremental scan (1 ms)
    QueryEngine
      ✓ should find symbol by ID (1 ms)
      ✓ should return null for non-existent ID
      ✓ should find symbols by name
      ✓ should find symbols by partial name (1 ms)
      ✓ should find symbols by kind
      ✓ should find symbols by file
      ✓ should find exported symbols
      ✓ should search with multiple filters (1 ms)
      ✓ should get file dependencies
      ✓ should get file summary
      ✓ should get codebase summary (1 ms)
      ✓ should find symbols by topic
      ✓ should format symbols for prompt
      ✓ should convert to handles (1 ms)
      ✓ should build dependency graph
      semanticSearch (with fallback)
        ✓ should return keyword-matched results when Ollama unavailable (1 ms)
        ✓ should filter by kinds (1 ms)
        ✓ should limit results by maxResults
        ✓ should return empty array for no matches
      getSmartContext (with fallback)
        ✓ should return context object with symbols
        ✓ should include relevant symbols (1 ms)
        ✓ should track files in context
        ✓ should return empty context for no matches
      explainSymbol (with fallback)
        ✓ should return explanation for valid symbol (1 ms)
        ✓ should return null for non-existent symbol
        ✓ should generate basic description without LLM
        ✓ should include different descriptions for different kinds
      rankSymbols (with fallback)
        ✓ should rank symbols by relevance (1 ms)
        ✓ should return empty array for empty input
        ✓ should boost exported symbols (1 ms)
      isLLMAvailable
        ✓ should return false when LocalLLM not configured
    CodeIndex (Integration)
      ✓ should build index from directory (1 ms)
      ✓ should cache index to disk (1 ms)
      ✓ should load index from cache (1 ms)
      ✓ should clear cache (2 ms)
      ✓ should find relevant symbols (2 ms)
      ✓ should get symbol context (1 ms)
      ✓ should search with filters (1 ms)
      ✓ should throw error when not built (9 ms)
      ✓ should format symbols for LLM prompt (1 ms)
      Ollama-Enhanced Methods
        ✓ semanticSearch should work with fallback (1 ms)
        ✓ getSmartContext should return context object (2 ms)
        ✓ getSmartContext with includeCode should add code snippets (2 ms)
        ✓ explainSymbol should return explanation (1 ms)
        ✓ rankSymbols should rank by relevance (1 ms)
        ✓ isLLMAvailable should return boolean (2 ms)
        ✓ should throw error for Ollama methods when not built
  Language Patterns
    ✓ should export SYMBOL_KINDS
    ✓ should export PATTERNS
    ✓ should export FILE_EXTENSIONS
    ✓ isReactComponentName should detect component names
    ✓ isReactHookName should detect hook names
    ✓ inferKind should infer React component kind
    ✓ inferKind should infer React hook kind
    ✓ extractParams should parse function parameters

PASS src/shared/config/state.test.js
  State
    setFolder
      ✓ should set folder and claudiomiro folder paths (1 ms)
      ✓ should migrate legacy claudiomiro layout into task-executor subfolder (1 ms)
      ✓ should fall back to legacy root when migration fails (1 ms)
      ✓ should resolve relative paths
    cacheFolder
      ✓ should return cache folder path
    initializeCache
      ✓ should do nothing if claudiomiro folder not set (1 ms)
      ✓ should create cache folder if it does not exist
      ✓ should not create cache folder if it already exists (2 ms)
    hasCacheFolder
      ✓ should return true if cache folder exists
      ✓ should return false if cache folder does not exist (1 ms)
    setExecutorType
      ✓ should set valid executor type
      ✓ should throw error for invalid executor type (7 ms)
    executorType
      ✓ should default to claude (1 ms)
    multi-repo support
      isMultiRepo
        ✓ should return false by default
        ✓ should return true after setMultiRepo is called
      setMultiRepo
        ✓ should set all multi-repo properties (1 ms)
        ✓ should resolve backend and frontend paths
        ✓ should call setFolder with backend path
        ✓ should work with separate mode (1 ms)
        ✓ should preserve initial workspace folder when switching repositories
        ✓ should throw error if backend path does not exist
        ✓ should throw error if frontend path does not exist (1 ms)
        ✓ should throw error if backend is not a git repository
        ✓ should throw error if frontend is not a git repository
      getRepository
        ✓ should return backend path for backend scope (1 ms)
        ✓ should return frontend path for frontend scope (5 ms)
        ✓ should return primary folder for integration scope (1 ms)
        ✓ should return primary folder for unknown scope
        ✓ should log warning for unknown scope in multi-repo mode
        ✓ should not log warning for valid scopes
        ✓ should return _folder in single-repo mode (1 ms)
      getGitMode
        ✓ should return null by default
        ✓ should return monorepo when configured
        ✓ should return separate when configured
      getGitRoots
        ✓ should return empty array by default (1 ms)
        ✓ should return git roots after setMultiRepo
      backward compatibility
        ✓ existing single-repo methods still work after multi-repo setup
        ✓ setFolder still works independently

PASS src/commands/task-executor/steps/step6/reanalyze-failed.test.js
  reanalyze-failed
    skip conditions
      ✓ should skip when TODO.old.md already exists (1 ms)
    backup and restore flow
      ✓ should create backup and timestamped backup before deleting TODO.md
      ✓ should restore TODO.md when creation fails (6 ms)
      ✓ should cleanup TODO.old.md after successful TODO.md creation
    context file collection
      ✓ should include AI_PROMPT.md in context (1 ms)
      ✓ should include RESEARCH.md when it exists
      ✓ should handle missing RESEARCH.md gracefully
    failure history processing
      ✓ should include failure history when info.json exists with errorHistory
      ✓ should handle missing info.json gracefully
      ✓ should handle info.json without errorHistory gracefully
      ✓ should format last 3 errors from errorHistory
    prompt template processing
      ✓ should load reanalyze-prompt.md template (1 ms)
      ✓ should replace all placeholders in template
      ✓ should include TODO template from templates directory
    executeClaude integration
      ✓ should call executeClaude with built prompt
      ✓ should return executeClaude result
      ✓ should propagate executeClaude errors (1 ms)
    timestamp generation
      ✓ should use consistent timestamp for backup files

PASS src/shared/services/insights/insight-store.test.js
  insight-store
    ✓ returns default structure when global insights file is missing (1 ms)
    ✓ persists project insight to project file (3 ms)
    ✓ categorizes curated insight scope automatically (2 ms)
    ✓ merges global and project insights when loading all data (2 ms)
    ✓ redirects project-scoped insights away from the global store (1 ms)
    ✓ ranks curated insights by relevance for a task (2 ms)
    ✓ increments usage count for project insight (1 ms)
    ✓ stores and retrieves reflections per task (4 ms)

PASS src/shared/utils/diff-applier.test.js
  DiffApplier
    parseDiff
      ✓ should parse a simple unified diff (3 ms)
      ✓ should handle empty diff
      ✓ should parse multi-file diff
    applyPatch
      ✓ should apply a simple addition patch (1 ms)
      ✓ should apply a simple removal patch
      ✓ should apply a replacement patch
      ✓ should handle empty patch (1 ms)
      ✓ should return error for mismatched context
      ✓ should use fuzzFactor for approximate matching
    applyMultiFilePatch
      ✓ should apply patches to multiple files
      ✓ should handle new file creation (1 ms)
      ✓ should report errors for missing files without new content
    extractFilePath
      ✓ should remove a/ prefix
      ✓ should remove b/ prefix
      ✓ should handle paths without prefix
      ✓ should return null for null input
      ✓ should return empty string for empty input
    extractDiffsFromOutput
      ✓ should extract diff from code block
      ✓ should extract multiple diff blocks
      ✓ should handle patch code blocks (1 ms)
      ✓ should return empty array for output without diffs
      ✓ should extract raw diff without code blocks
    validateDiff
      ✓ should validate a correct diff
      ✓ should reject diff without header
      ✓ should reject diff without hunks
      ✓ should reject empty diff
      ✓ should reject non-string input (1 ms)
    createDiff
      ✓ should create diff for added content
      ✓ should create diff for removed content (1 ms)
      ✓ should create diff for replaced content
      ✓ should create empty diff for identical content
    reconstructPatchString
      ✓ should reconstruct valid patch string from parsed patch
    createNewFileFromPatch
      ✓ should create file content from new file patch
      ✓ should handle empty patch
    Class instantiation
      ✓ should be able to create new instances
      ✓ singleton should be instance of DiffApplier (1 ms)
    Integration scenarios
      ✓ should handle real-world LLM output with explanation and diff
      ✓ should handle simple single-hunk patch
      ✓ should create diff and re-apply it

PASS src/commands/fix-command/executor.test.js
  fix-command
    executeCommand
      ✓ should spawn command with correct parameters on Linux (1 ms)
      ✓ should spawn command with correct parameters on Windows (1 ms)
      ✓ should initialize state folder if not set
      ✓ should create claudiomiro folder if it does not exist
      ✓ should create log stream with correct path
      ✓ should write log headers with timestamp
      ✓ should handle stdout data
      ✓ should handle stderr data (1 ms)
      ✓ should handle successful command execution
      ✓ should handle failed command execution
      ✓ should handle process error (1 ms)
      ✓ should wrap long lines correctly (1 ms)
      ✓ should stop spinner and log command execution
    fixCommand
      ✓ should succeed on first attempt and exit
      ✓ should attempt to fix command on failure (41 ms)
      ✓ should create claudiomiro folder if it does not exist (12 ms)
      ✓ should handle Claude execution error gracefully (13 ms)
      ✓ should respect maxAttempts parameter (33 ms)
      ✓ should handle zero maxAttempts
      ✓ should use correct command in error message
      ✓ should handle special characters in command (11 ms)
      ✓ should handle very long commands (12 ms)
    Edge cases and error handling
      ✓ should handle empty command (1 ms)
      ✓ should handle command with only whitespace
      ✓ should handle executeCommand throwing exception
      ✓ should handle undefined/null command gracefully (1 ms)
    Enhanced Platform-Specific Testing
      Shell Selection and Command Formatting
        ✓ should use bash on Linux platform
        ✓ should use bash on macOS platform
        ✓ should use cmd.exe on Windows platform
        ✓ should handle Windows path separators correctly
        ✓ should handle Unix path separators correctly (1 ms)
      Platform-Specific Command Quoting
        ✓ should handle commands with single quotes on Unix systems
        ✓ should handle commands with double quotes on Windows
        ✓ should handle commands with escaped quotes on Unix
        ✓ should handle environment variable syntax differences (1 ms)
        ✓ should handle Windows environment variable syntax
      Executable Handling and File Extensions
        ✓ should handle Windows executable extensions
        ✓ should handle Unix executables without extensions
        ✓ should handle shell script execution on Unix systems
        ✓ should handle batch file execution on Windows (1 ms)
      Working Directory Handling
        ✓ should handle Windows-style working directory paths
        ✓ should handle Unix-style working directory paths
        ✓ should handle relative working directories
      Platform-Specific Error Handling
        ✓ should handle Windows file not found errors (1 ms)
        ✓ should handle Unix file not found errors
        ✓ should handle Windows permission denied errors
        ✓ should handle Unix permission denied errors
    Complex Command Reconstruction Tests
      Multi-Argument Commands with Flags
        ✓ should handle commands with multiple flags and arguments
        ✓ should handle commands with short and long flag combinations (1 ms)
        ✓ should handle npm scripts with complex arguments
      Nested and Escaped Quotes
        ✓ should handle commands with nested single quotes inside double quotes
        ✓ should handle commands with escaped double quotes
        ✓ should handle commands with backticks
        ✓ should handle commands with complex nested quoting (1 ms)
      Special Characters and Symbols
        ✓ should handle commands with environment variable expansions
        ✓ should handle commands with redirection operators
        ✓ should handle commands with pipes and chaining
        ✓ should handle commands with wildcard patterns
        ✓ should handle commands with special shell characters (1 ms)
      Very Long Commands and Line Wrapping
        ✓ should handle extremely long commands without breaking syntax
        ✓ should handle commands with long file paths
        ✓ should properly wrap long commands in console output
      Command Sanitization and Security
        ✓ should handle potentially dangerous command characters safely (1 ms)
        ✓ should handle commands with command substitution
        ✓ should handle arithmetic expressions
      Multi-line Commands and Scripts
        ✓ should handle commands with line continuations
        ✓ should handle commands with semicolon separators
        ✓ should handle logical operators in commands (1 ms)
    Enhanced Retry Logic Testing
      Retry Success Patterns
        ✓ should succeed after initial failure (33 ms)
        ✓ should succeed after multiple failures (52 ms)
        ✓ should succeed on last possible attempt (1 ms)
      Maximum Attempts Limit Enforcement
        ✓ should stop after maxAttempts when all attempts fail (31 ms)
        ✓ should handle zero maxAttempts (1 ms)
        ✓ should handle negative maxAttempts gracefully
        ✓ should respect large maxAttempts values (106 ms)
      Different Failure Types and Patterns
        ✓ should handle command not found errors repeatedly (21 ms)
        ✓ should handle permission denied errors repeatedly (32 ms)
        ✓ should handle timeout scenarios (22 ms)
        ✓ should handle intermittent failures (1 ms)
        ✓ should handle different error messages for same command (43 ms)
      Claude Executor Interaction During Retries
        ✓ should handle Claude executor success but command still failing (21 ms)
        ✓ should handle Claude executor failures during retries (22 ms)
        ✓ should continue retries even if Claude executor fails (2 ms)
      State Management During Retries
        ✓ should maintain command integrity across retries (22 ms)
        ✓ should handle concurrent fixCommand calls independently (22 ms)
      Progressive Retry Strategy Testing
        ✓ should track attempt numbers correctly (32 ms)
        ✓ should handle retry timing and delays properly (32 ms)
    Comprehensive Logging and Reporting
      Log File Creation and Management
        ✓ should create log file with correct path and flags (1 ms)
        ✓ should create log file when claudiomiro folder does not exist
        ✓ should handle different claudiomiro folder paths (1 ms)
      Log Content and Formatting
        ✓ should write proper log headers with timestamps and separators
        ✓ should capture and log stdout output correctly
        ✓ should capture and log stderr output correctly (1 ms)
        ✓ should handle mixed stdout and stderr output
      Error Logging and Stack Traces
        ✓ should log process errors with proper formatting
        ✓ should log error details in execution context
        ✓ should handle errors during different execution phases
      Log Stream Management
        ✓ should properly end log stream on successful completion (1 ms)
        ✓ should properly end log stream on command failure (1 ms)
        ✓ should properly end log stream on process error (1 ms)
      Concurrent Logging Scenarios
        ✓ should handle multiple commands logging simultaneously (1 ms)
        ✓ should handle log stream write failures gracefully (2 ms)
      Log Content Validation
        ✓ should maintain consistent log format across different platforms
        ✓ should handle special characters in log output
        ✓ should handle very long log entries
      Log Performance and Resource Management
        ✓ should handle high-frequency log writes efficiently (1 ms)
        ✓ should clean up log resources properly on errors

PASS src/commands/task-executor/services/parallel-ui-renderer.test.js
  ParallelUIRenderer
    Constructor
      ✓ should initialize with TerminalRenderer (1 ms)
      ✓ should throw error if TerminalRenderer is not provided (12 ms)
      ✓ should initialize with correct spinner types
    getColorForStatus
      ✓ should return green for completed status
      ✓ should return yellow for running status
      ✓ should return red for failed status (1 ms)
      ✓ should return gray for pending status
      ✓ should return gray for unknown status
    getSpinnerFrame
      ✓ should return a frame from the specified spinner type
      ✓ should cycle through spinner frames
      ✓ should fall back to dots spinner for unknown type
    renderTaskLine
      ✓ should render task line with all components (1 ms)
      ✓ should render task line with only status
      ✓ should include spinner for running tasks
      ✓ should not include spinner for non-running tasks
      ✓ should use different spinners for different task indices
      ✓ should sanitize multiline task data into single line (1 ms)
      ✓ should display Done for completed tasks without Claude message
    truncateLine
      ✓ should not truncate lines shorter than max width
      ✓ should truncate lines exceeding max width
      ✓ should handle lines with ANSI color codes (1 ms)
    renderFrame
      ✓ should render header with progress percentage (2 ms)
      ✓ should render all task lines
      ✓ should handle empty task states
      ✓ should handle null task states
      ✓ should truncate lines to terminal width (1 ms)
      ✓ should handle tasks with missing fields
      ✓ should calculate progress based on step completion
    start
      ✓ should throw error if stateManager is not provided
      ✓ should throw error if progressCalculator is not provided (1 ms)
      ✓ should hide cursor on start
      ✓ should mark UI renderer as active when supported
      ✓ should stop logger spinner when starting (1 ms)
      ✓ should create interval with 200ms delay
      ✓ should call renderFrame and renderBlock on interval
      ✓ should increment frame counter on each render
    stop
      ✓ should clear interval
      ✓ should render final static frame (1 ms)
      ✓ should show cursor after stop
      ✓ should mark UI renderer as inactive when stopped
      ✓ should handle stop when not started
    Edge Cases
      ✓ should handle very long task names (1 ms)
      ✓ should handle special characters in task names
      ✓ should handle rapid start/stop cycles
    Advanced Terminal Control and Animation Concurrency
      ✓ should handle real-time rendering with concurrent state changes (1 ms)
      ✓ should maintain cursor management under concurrent start/stop operations
      ✓ should handle concurrent UI component rendering without interference (1 ms)
      ✓ should handle animation timing with precise frame progression
      ✓ should validate ANSI color code handling under concurrent updates (1 ms)
    Memory Leak Detection and Resource Management
      ✓ should properly cleanup render intervals on stop
      ✓ should handle extended rendering sessions without memory accumulation (8 ms)
      ✓ should handle rapid terminal width changes during rendering
      ✓ should prevent resource leaks under error conditions (1 ms)
    Performance Testing for High-Frequency UI Updates
      ✓ should maintain 200ms render intervals under high load (5 ms)
      ✓ should handle efficient rendering of large task sets (1 ms)
    Integration with ParallelStateManager
      ✓ should coordinate end-to-end workflow with state manager (2 ms)
      ✓ should handle complex multi-task lifecycle scenarios
      ✓ should handle error recovery and state corruption scenarios (1 ms)
      ✓ should validate end-to-end state synchronization consistency

PASS src/commands/task-executor/steps/step1/index.test.js
  step1
    step1
      ✓ should skip if AI_PROMPT.md already exists (2 ms)
      ✓ should generate AI_PROMPT.md when it does not exist (1 ms)
      ✓ should throw error if AI_PROMPT.md not created after execution (5 ms)
      ✓ should handle branch step parameter (sameBranch = true) (1 ms)
      ✓ should handle missing INITIAL_PROMPT.md gracefully (1 ms)
    generateMultiRepoContext
      ✓ should return empty string when single-repo mode
      ✓ should return markdown context when multi-repo mode enabled
      ✓ should include @scope documentation in multi-repo context
      ✓ should include code example with @scope tag (1 ms)
    step1 with multi-repo context
      ✓ should include multi-repo context in prompt when multi-repo enabled
      ✓ should NOT include multi-repo context when single-repo mode (backward compatibility)

PASS src/shared/services/local-llm/fallbacks/topic-classifier.test.js
  topic-classifier
    classifyTopics
      ✓ should classify authentication-related content (3 ms)
      ✓ should classify API-related content (3 ms)
      ✓ should classify database-related content
      ✓ should classify testing-related content (1 ms)
      ✓ should classify multiple topics
      ✓ should respect maxTopics limit
      ✓ should return empty array for empty content
      ✓ should handle content with no matching topics (1 ms)
      ✓ should be case-insensitive
      ✓ should weight longer keywords higher
    getTopicSimilarity
      ✓ should return 1.0 for identical arrays
      ✓ should return 0.0 for completely different arrays
      ✓ should return partial similarity for overlapping arrays
      ✓ should return 0.0 for empty arrays
      ✓ should handle single element arrays
    TOPIC_KEYWORDS
      ✓ should have all expected topic categories (3 ms)
      ✓ should have keywords as strings (7 ms)

PASS src/commands/task-executor/steps/step5/reflection-hook.test.js
  reflection-hook
    ✓ determines when reflection should run based on attempts (1 ms)
    ✓ builds trajectory content from task artifacts (2 ms)
    ✓ creates reflection and parses insights (2 ms)
    ✓ stores reflection iterations via insights service (1 ms)

PASS src/commands/test-local-llm/index.test.js
  test-local-llm command
    printHeader
      ✓ should display header with title
    printStatus
      ✓ should display connected status when available
      ✓ should display error when not available
      ✓ should truncate long model list
    generateResponse
      ✓ should generate and display response (1 ms)
      ✓ should display error on failure (3 ms)
    run
      ✓ should show instructions when LLM not enabled (1 ms)
      ✓ should exit with error when Ollama not available
      ✓ should exit with error when model not installed (1 ms)
      ✓ should use prompt from args
      ✓ should handle quoted prompt in args (1 ms)
      ✓ should ask for prompt interactively when not provided
      ✓ should handle empty prompt gracefully

PASS src/shared/services/git-commit.test.js
  git-commit
    commitOrFix
      ✓ should execute Claude with enhanced prompt containing hard rules (1 ms)
      ✓ should work without taskName parameter
      ✓ should stop spinner and log appropriate messages
      ✓ should handle Claude execution success
      ✓ should handle Claude execution failure gracefully
      ✓ should handle empty prompt (1 ms)
      ✓ should handle prompt with special characters
      ✓ should handle very long prompts
      ✓ should preserve original prompt in enhanced message
      ✓ should format hard rules consistently
      ✓ should pass through taskName parameter correctly
      ✓ should handle different task names (1 ms)
      ✓ should handle execution errors with different error types
      ✓ should call logger methods in correct order on success
      ✓ should call logger methods in correct order on failure
      ✓ should handle multiline prompts
      ✓ should handle prompts with git commands
      ✓ should maintain consistency across multiple calls (1 ms)
      cwd parameter
        ✓ should pass cwd to executeClaude
        ✓ should use state.folder when cwd not provided
        ✓ should use null cwd as state.folder
    smartCommit
      when no changes to commit
        ✓ should return success with no changes message
      when git status fails
        ✓ should fall back to Claude
      when local LLM is not available
        ✓ should fall back to Claude
      when local LLM is available
        ✓ should commit via shell with Ollama message
        ✓ should stage all changes before commit
        ✓ should include commit body when present (1 ms)
        ✓ should push when shouldPush is true
        ✓ should not push when shouldPush is false
        ✓ should fall back to Claude when push fails and createPR is true
        ✓ should return success when push fails but createPR is false
        ✓ should use Claude for PR creation
        ✓ should read TASK.md for task description (1 ms)
      when shell commit fails
        ✓ should fall back to Claude
      default parameters
        ✓ should use defaults when no options provided
        ✓ should use taskName when provided
      cwd parameter
        ✓ should use state.folder when cwd not provided
        ✓ should use custom cwd for git status when provided
        ✓ should use custom cwd for git add when provided
        ✓ should use custom cwd for git commit when provided (1 ms)
        ✓ should use custom cwd for git push when provided
        ✓ should pass custom cwd to Claude on fallback
        ✓ should pass custom cwd through all git operations

PASS src/shared/services/git-detector.test.js
  git-detector
    findGitRoot
      ✓ should return git root for valid directory
      ✓ should return null for non-git directory
      ✓ should trim whitespace from git root path (1 ms)
      ✓ should resolve relative paths before calling git
    detectGitConfiguration
      ✓ should return monorepo mode when same git root
      ✓ should return separate mode when different git roots
      ✓ should throw error when backend is not in git repo (4 ms)
      ✓ should throw error when frontend is not in git repo
      ✓ should throw error when both paths are not in git repos

PASS src/shared/executors/codex-logger.test.js
  Codex Logger
    processCodexEvent
      ✓ should return null for empty or whitespace input
      ✓ should return null for invalid JSON
      ✓ should return null for empty JSON object (1 ms)
      ✓ should return item.text when present
      ✓ should return formatted command when item.command is present
      ✓ should return prompt when present
      ✓ should return msg.text when present
      ✓ should handle msg.type with token_count (should return null)
      ✓ should handle msg.type containing exec_command
      ✓ should handle msg.type containing agent_reasoning
      ✓ should return msg.type for other message types
      ✓ should prioritize item.text over other properties
      ✓ should return truncated JSON string for unrecognized structure (1 ms)
      ✓ should handle short JSON strings without truncation
      ✓ should handle malformed JSON gracefully
      ✓ should handle msg with missing text property
      ✓ should handle msg with empty text
      ✓ should handle item with empty command
      ✓ should handle item with empty text
      ✓ should handle complex nested structures
      ✓ should handle Unicode and special characters
      ✓ should handle multiple message types correctly (1 ms)
    format integration through processCodexEvent
      ✓ should format command execution with exit code
      ✓ should handle file operations (1 ms)
      ✓ should handle web search operations
      ✓ should handle MCP tool calls
    Edge cases and error handling
      ✓ should handle extremely long JSON strings (1 ms)
      ✓ should handle null and undefined values in JSON
      ✓ should handle numeric values in JSON
      ✓ should handle boolean values in JSON
      ✓ should handle array values in JSON
    OpenAI-Specific API Response Patterns
      ✓ should handle OpenAI token usage information
      ✓ should handle OpenAI cost tracking information
      ✓ should handle OpenAI function call format (1 ms)
      ✓ should handle OpenAI tool result format
      ✓ should handle OpenAI streaming response chunks
      ✓ should handle OpenAI API error responses
      ✓ should handle OpenAI invalid request error
    Agent Reasoning and Complex Workflows
      ✓ should handle multi-step agent reasoning process
      ✓ should handle chain-of-thought reasoning
      ✓ should handle complete conversation workflow
    MCP (Model Context Protocol) Integration
      ✓ should handle MCP tool call interactions
      ✓ should handle MCP tool results
    Parallel Processing State Management
      ✓ should handle parallel task coordination (1 ms)
      ✓ should handle parallel task progress updates
    Performance and Memory Edge Cases
      ✓ should handle large payload processing
      ✓ should handle rapid event processing simulation
      ✓ should handle complex nested JSON structures
    Critical Bug Fix Verification
      ✓ should correctly handle msg.text property (previously had typo bug)
      ✓ should handle msg.text with various content types

PASS src/shared/services/integration-verifier.test.js
  integration-verifier
    extractBalancedJson
      ✓ should extract simple JSON object (1 ms)
      ✓ should extract JSON from wrapped text
      ✓ should handle nested objects
      ✓ should handle arrays with objects
      ✓ should handle strings with braces inside
      ✓ should handle escaped quotes in strings
      ✓ should return null for no JSON
      ✓ should return null for empty string
      ✓ should extract first JSON when multiple objects present
      ✓ should handle unbalanced braces (return null)
    buildVerificationPrompt
      ✓ should include both backend and frontend paths in prompt
      ✓ should request JSON format response
      ✓ should include mismatch type definitions
      ✓ should embed output instructions when outputPath provided
    parseVerificationResult
      ✓ should parse clean JSON correctly (1 ms)
      ✓ should parse JSON with mismatches
      ✓ should extract JSON from wrapped text
      ✓ should return parse_error for malformed JSON
      ✓ should return parse_error for empty input
      ✓ should return parse_error for null input
      ✓ should return parse_error when no JSON object found
      ✓ should return parse_error for invalid JSON structure (1 ms)
    verifyIntegration
      ✓ should return success result when Claude finds no issues
      ✓ should return mismatches when Claude finds issues (1 ms)
      ✓ should call executeClaude with correct arguments including cwd option
      ✓ should return execution_error when executeClaude throws
      ✓ should handle parse errors from malformed Claude response (2 ms)

PASS src/commands/task-executor/utils/terminal-renderer.test.js
  TerminalRenderer
    constructor
      ✓ should initialize with lastLineCount of 0
    hideCursor
      ✓ should write correct ANSI escape code to hide cursor (1 ms)
      ✓ should handle missing stdout gracefully
      ✓ should handle missing write method gracefully
    showCursor
      ✓ should write correct ANSI escape code to show cursor
      ✓ should handle missing stdout gracefully
      ✓ should handle missing write method gracefully
    moveCursorUp
      ✓ should write correct ANSI code for moving cursor up 1 line
      ✓ should write correct ANSI code for moving cursor up 5 lines
      ✓ should not write anything for count of 0
      ✓ should not write anything for negative count
      ✓ should handle missing stdout gracefully
    getTerminalWidth
      ✓ should return process.stdout.columns when available
      ✓ should return default 80 when stdout is null
      ✓ should return default 80 when columns is undefined
      ✓ should return default 80 when columns is 0
      ✓ should return correct width for narrow terminal (2 ms)
      ✓ should return correct width for wide terminal
    clearLines
      ✓ should clear 1 line correctly
      ✓ should clear 3 lines correctly
      ✓ should not write anything for count of 0
      ✓ should not write anything for negative count
      ✓ should handle missing stdout gracefully
      ✓ should handle missing write method gracefully (1 ms)
    clearScreen
      ✓ should write correct ANSI codes to clear screen
      ✓ should handle missing stdout gracefully
      ✓ should handle missing write method gracefully
    renderBlock
      ✓ should render single line
      ✓ should render multiple lines
      ✓ should clear previous content before rendering new content
      ✓ should handle empty array
      ✓ should handle null gracefully (1 ms)
      ✓ should handle undefined gracefully
      ✓ should handle non-array gracefully
      ✓ should handle missing stdout gracefully
      ✓ should handle missing write method gracefully
      ✓ should update state correctly across multiple renders
      ✓ should handle render after clear
      ✓ should not move cursor on first render (1 ms)
      ✓ should handle lines with special characters
    reset
      ✓ should reset lastLineCount to 0
      ✓ should allow fresh rendering after reset
    integration scenarios
      ✓ should handle typical usage flow: hide cursor, render, show cursor
      ✓ should handle clearing and re-rendering efficiently
      ✓ should handle rapid successive renders

PASS src/shared/services/git-status.test.js
  git-status
    gitStatus
      ✓ should spawn git status command with correct parameters (2 ms)
      ✓ should handle git status output (1 ms)
      ✓ should handle clean repository (no output) (2 ms)
      ✓ should handle git status error and reject (1 ms)
      ✓ should handle multiline git status output (1 ms)
      ✓ should accumulate output from multiple stdout data events (23 ms)
      ✓ should accumulate stderr and include it in error message (21 ms)
      ✓ should handle multiple stderr data events (22 ms)
      ✓ should handle empty stderr with non-zero exit code (2 ms)
      ✓ should handle large stderr output (20 ms)
      ✓ should handle git not initialized error (22 ms)
      ✓ should handle permission denied error (23 ms)

PASS src/shared/utils/auto-update.test.js
  auto-update
    getCurrentVersion
      ✓ should read and return current version from package.json
      ✓ should handle package.json with different version format (1 ms)
    getLatestVersion
      ✓ should return latest version from npm
      ✓ should return null when npm command fails
      ✓ should trim whitespace from npm output
    checkForUpdates
      ✓ should return update available when versions differ
      ✓ should show warning message when update is available and not silent
      ✓ should not show warning message when silent option is true (1 ms)
      ✓ should return no update when versions are the same
      ✓ should return no update when latest version is null
      ✓ should auto-update when autoUpdate option is true
      ✓ should handle auto-update failure gracefully
      ✓ should handle errors gracefully and return error info
      ✓ should use default package name when not provided (1 ms)
    checkForUpdatesAsync
      ✓ should execute checkForUpdates asynchronously without blocking (99 ms)
      ✓ should not throw error when check fails (102 ms)
      ✓ should use default options when not provided (100 ms)
      ✓ should silently catch errors and not crash (101 ms)

PASS src/shared/executors/glm-executor.test.js
  GLM Executor
    executeGlm
      ✓ should call runGlm when executorType is not codex (3 ms)
      ○ skipped should delegate to executeCodex when executorType is codex
    runGlm internal functionality
      ✓ should throw error when no prompt provided (10 ms)
      ✓ should create temporary file with prompt text (1 ms)
      ✓ should spawn GLM process with correct command (2 ms)
      ✓ should create log stream with correct path (1 ms)
      ✓ should write log headers with timestamp (1 ms)
      ✓ should handle stdout data processing (1 ms)
      ✓ should handle stderr data (1 ms)
      ✓ should update state manager when taskName provided (2 ms)
      ✓ should suppress streaming logs when UI renderer is active (2 ms)
      ✓ should handle process close with success code (1 ms)
      ✓ should handle process close with error code (2 ms)
      ✓ should handle process error (2 ms)
      ✓ should cleanup temporary file on successful completion (1 ms)
      ✓ should cleanup temporary file on error (1 ms)
      ✓ should handle cleanup error gracefully (2 ms)
      ✓ should reset timeout on data received (1 ms)
      ✓ should handle long text wrapping (1 ms)
      ✓ should handle empty processed message (1 ms)
      ○ skipped should implement timeout mechanism
    overwriteBlock function
      ✓ should use ANSI escape sequences correctly
    Edge cases and error handling
      ✓ should handle JSON parsing errors gracefully (1 ms)
      ✓ should handle extremely long output (2 ms)
      ✓ should handle multiple rapid stdout updates (1 ms)
    State management integration
      ✓ should not update state manager when no taskName provided (1 ms)
      ✓ should handle state manager without isUIRendererActive method (1 ms)

PASS src/commands/task-executor/steps/step8/index.test.js
  step8
    step8
      ✓ should execute commit/push and exit successfully (1 ms)
      ✓ should call smartCommit without push and PR when shouldPush is false
      ✓ should call smartCommit with push and PR when shouldPush is true
      ✓ should create done.txt with correct content (1 ms)
      ✓ should log success message with folder path
      ✓ should log shell method when commit via shell
      ✓ should log claude method when commit via Claude
      ✓ should warn and continue when smartCommit fails
      ✓ should call process.exit with code 0
      ✓ should NOT write done.txt when commit fails
      ✓ should handle tasks parameter (even though not used) (1 ms)
    monorepo mode
      ✓ should use smartCommit with createPR for monorepo mode
    separate git mode (multi-repo)
      ✓ should create commits in both repos for separate git mode
      ✓ should create PRs with cross-references in separate git mode (3 ms)
      ✓ should update backend PR with frontend URL after both PRs created
      ✓ should use correct cwd for each repository
      ✓ should fall back to single-repo when shouldPush is false
      ✓ should handle gh pr create failure gracefully (1 ms)
      ✓ should handle gh pr edit failure gracefully

PASS src/shared/services/local-llm/fallbacks/dependency-parser.test.js
  dependency-parser
    parseDependencies
      ✓ should parse @dependencies with brackets (1 ms)
      ✓ should parse @dependencies without brackets (1 ms)
      ✓ should be case-insensitive
      ✓ should handle "none" value
      ✓ should handle empty brackets
      ✓ should filter invalid task names (1 ms)
      ✓ should handle subtask format
      ✓ should return empty array for no dependencies (1 ms)
      ✓ should handle empty content (2 ms)
    parseDependsOn
      ✓ should parse "Depends on:" format (1 ms)
      ✓ should parse "Dependencies:" format
      ✓ should parse "Requires:" format
      ✓ should parse "Blocked by:" format
      ✓ should deduplicate results
    extractTaskReferences
      ✓ should find all TASK references
      ✓ should deduplicate references
      ✓ should handle subtask format
    getAllDependencies
      ✓ should combine explicit dependencies
      ✓ should separate explicit and inferred
    validateDependencyGraph
      ✓ should validate acyclic graph
      ✓ should detect simple cycle
      ✓ should detect complex cycle
      ✓ should handle empty graph
      ✓ should handle self-dependency
    getTopologicalOrder
      ✓ should return correct order for linear dependencies (1 ms)
      ✓ should return correct order for diamond dependencies
      ✓ should return null for cyclic graph
      ✓ should handle independent tasks

PASS src/commands/task-executor/index.test.js
  src/commands/task-executor/index.js
    run()
      ✓ should call init with provided args
      ✓ should call init with empty array when no args provided
      ✓ should pass through all args to init
      ✓ should return promise that resolves when init completes
      ✓ should propagate errors from init (2 ms)
    exports
      ✓ should export run function

PASS src/shared/executors/codex-executor.test.js
  Codex Executor
    executeCodex
      ✓ should throw error when no prompt provided (10 ms)
      ✓ should create temporary file with prompt text (3 ms)
      ✓ should spawn Codex process with correct command (2 ms)
      ✓ should create log stream with correct path (2 ms)
      ✓ should write log headers with timestamp (1 ms)
      ✓ should handle stdout data processing (2 ms)
      ✓ should handle stderr data (2 ms)
      ✓ should update state manager when taskName provided (2 ms)
      ✓ should suppress streaming logs when UI renderer is active (3 ms)
      ✓ should handle process close with success code (2 ms)
      ✓ should handle process close with error code (1 ms)
      ✓ should handle process error (2 ms)
      ✓ should cleanup temporary file on successful completion (2 ms)
      ✓ should cleanup temporary file on error (2 ms)
      ✓ should handle cleanup error gracefully (1 ms)
      ✓ should implement timeout mechanism (1 ms)
      ✓ should handle long text wrapping (1 ms)
      ✓ should handle empty processed event (2 ms)
    overwriteBlock function
      ✓ should use ANSI escape sequences correctly
    Edge cases and error handling
      ✓ should handle JSON parsing errors gracefully (1 ms)
      ✓ should handle extremely long output (1 ms)
      ✓ should handle multiple rapid stdout updates (2 ms)
    State management integration
      ✓ should not update state manager when no taskName provided (2 ms)
      ✓ should handle state manager without isUIRendererActive method (1 ms)
    Codex-specific functionality
      ✓ should handle different Codex event types (2 ms)
      ✓ should handle Codex-specific output formatting (1 ms)

PASS src/commands/task-executor/services/deadlock-resolver.test.js
  deadlock-resolver
    detectCycles
      ✓ should detect simple circular dependency between two tasks
      ✓ should detect circular dependency among three tasks
      ✓ should return empty array when no cycles exist
      ✓ should handle tasks with no dependencies (1 ms)
      ✓ should handle complex graph with multiple independent cycles
      ✓ should handle self-referencing task
      ✓ should handle missing dependency references gracefully
      ✓ should handle empty task graph
      ✓ should detect cycle in diamond pattern with back-edge
    parseDependencies
      ✓ should parse dependencies in bracket format (1 ms)
      ✓ should parse dependencies without brackets
      ✓ should handle single dependency
      ✓ should return empty array when no dependencies
      ✓ should handle @dependencies none
      ✓ should handle empty brackets
      ✓ should trim whitespace from dependency names
    rebuildTaskGraphFromFiles
      ✓ should rebuild task graph from TASK.md files (1 ms)
      ✓ should skip tasks without TASK.md files
    resolveDeadlock
      ✓ should return true when AI successfully resolves deadlock (1 ms)
      ✓ should return false when cycles still exist after AI resolution
      ✓ should return false when executeClaude throws an error

PASS src/shared/executors/claude-executor.test.js
  Claude Executor
    executeClaude
      ✓ should throw error when no prompt provided (8 ms)
      ✓ should create temporary file with prompt text (1 ms)
      ✓ should spawn Claude process with correct command (2 ms)
      ✓ should handle stdout data processing (1 ms)
      ✓ should handle process close with success code (2 ms)
      ✓ should handle process close with error code (1 ms)
      ✓ should handle process error (2 ms)
      ✓ should update state manager when taskName provided (1 ms)
      ✓ should cleanup temporary file on successful completion (2 ms)
      ✓ should implement timeout mechanism
      ✓ should suppress streaming logs when UI renderer is active (2 ms)
      ✓ should handle stderr data logging
      ✓ should write log headers with timestamp (1 ms)
      ✓ should use state.folder as default cwd when no options provided (2 ms)
      ✓ should use provided cwd from options when specified (1 ms)
      ✓ should use state.folder when empty options object provided (1 ms)
      ✓ should use state.folder when options has undefined cwd (1 ms)
      ✓ should use provided cwd with taskName (2 ms)
    Edge cases and error handling
      ✓ should handle cleanup error gracefully (2 ms)
      ✓ should handle extremely long output (1 ms)

PASS src/shared/services/prompt-reader.test.js
  prompt-reader
    getMultilineInput
      ✓ should create readline interface with correct options (11 ms)
      ✓ should handle SIGINT cancellation (22 ms)
      ✓ should display formatted output (11 ms)
    getSimpleInput
      ✓ should create readline interface and handle question (6 ms)
      ✓ should handle SIGINT cancellation (21 ms)
      ✓ should trim whitespace from answer (6 ms)
    askClarificationQuestions
      ✓ should process JSON string questions and collect answers (2 ms)
      ✓ should process object questions and collect answers (1 ms)
      ✓ should handle multiple questions (3 ms)
      ✓ should throw error for malformed JSON string (6 ms)
      ✓ should throw error when questions is not an array
      ✓ should handle empty questions array
      ✓ should handle questions with options (1 ms)
      ✓ should handle questions with currentPatterns (2 ms)
      ✓ should handle Unicode content in questions and answers (1 ms)
      ✓ should verify timestamp format in response (1 ms)
      ✓ should handle questions with missing required fields (3 ms)

PASS src/shared/services/local-llm/index.test.js
  LocalLLMService
    initialization
      ✓ should initialize successfully when Ollama is available (1 ms)
      ✓ should fallback when Ollama is unavailable (1 ms)
      ✓ should be disabled by default when CLAUDIOMIRO_LOCAL_LLM not set
      ✓ should be disabled when CLAUDIOMIRO_LOCAL_LLM is set to "true" (no default model)
      ✓ should be enabled when CLAUDIOMIRO_LOCAL_LLM is set to model name
      ✓ should only initialize once
    classifyTopics
      ✓ should use LLM when available (1 ms)
      ✓ should fallback to heuristics when LLM unavailable (3 ms)
    extractSection
      ✓ should use LLM when available
      ✓ should fallback to regex when LLM unavailable
    summarize
      ✓ should use LLM when available (1 ms)
      ✓ should truncate when LLM unavailable
    checkCompletion
      ✓ should use LLM when available
      ✓ should fallback to heuristics when LLM unavailable
    analyzeDependencies
      ✓ should use LLM when available
      ✓ should fallback to regex when LLM unavailable (1 ms)
    generate
      ✓ should return text when LLM available
      ✓ should return null when LLM unavailable
    getStatus
      ✓ should return complete status (1 ms)
    singleton
      ✓ should return same instance (1 ms)
      ✓ should reset correctly

PASS src/commands/token-optimizer/executor.test.js
  src/commands/token-optimizer/executor.js
    runCommand()
      ✓ should execute command and capture stdout (1 ms)
      ✓ should capture stderr (1 ms)
      ✓ should capture both stdout and stderr
      ✓ should handle spawn error
      ✓ should default exit code to 1 when null
    buildFilterPrompt()
      ✓ should build prompt with command output and filter instruction
      ✓ should include conciseness instruction (1 ms)
    filterWithLLM()
      ✓ should return filtered output when LLM is available
      ✓ should return null when LLM is not available
    executeTokenOptimizer()
      ✓ should throw error if command is missing (8 ms)
      ✓ should throw error if filter is missing (1 ms)
      ✓ should return empty output when command produces no output
      ✓ should log when verbose is true and command produces no output
      ✓ should execute command and filter output with LLM without logging (1 ms)
      ✓ should log progress when verbose is true
      ✓ should fallback to original output when LLM is not available without logging (2 ms)
      ✓ should log fallback warning when verbose is true and LLM is not available
      ✓ should fallback to original output when LLM fails without logging (1 ms)
      ✓ should log fallback warning when verbose is true and LLM fails
    initializeTokenOptimizerFolder()
      ✓ should set folder when claudiomiroFolder is null
      ✓ should not set folder when claudiomiroFolder is already set
      ✓ should create token-optimizer folder when it does not exist
      ✓ should not create folder when it already exists
    generateOutputFilename()
      ✓ should generate filename with timestamp
      ✓ should generate unique filenames (1 ms)
    saveOutput()
      ✓ should save output to file with command and content
      ✓ should create folder if it does not exist
    exports
      ✓ should export runCommand function
      ✓ should export buildFilterPrompt function
      ✓ should export filterWithLLM function
      ✓ should export executeTokenOptimizer function
      ✓ should export initializeTokenOptimizerFolder function
      ✓ should export generateOutputFilename function (1 ms)
      ✓ should export saveOutput function

PASS src/shared/services/diff-service.test.js
  DiffService
    processOutput
      ✓ should return success with no diffs when output has no diffs (1 ms)
      ✓ should apply a simple diff from LLM output (2 ms)
      ✓ should handle multiple diffs in output (2 ms)
      ✓ should handle new file creation (1 ms)
      ✓ should dry run without modifying files (1 ms)
      ✓ should create backup files when backup option is true (1 ms)
    processSingleDiff
      ✓ should apply a valid diff (1 ms)
      ✓ should reject invalid diff
      ✓ should handle missing file
    rollback
      ✓ should rollback applied changes (2 ms)
    cleanupBackups
      ✓ should remove backup files (1 ms)
    resolveFilePath
      ✓ should resolve path from newFileName (1 ms)
      ✓ should resolve path from oldFileName when newFileName is /dev/null
      ✓ should return null for invalid patch
    module exports
      ✓ should export processOutput function
      ✓ should export processSingleDiff function (1 ms)

PASS src/commands/fix-branch/index.test.js
  fix-branch command
    getLevelInstructions
      ✓ should return blockers only instructions for level 1 (1 ms)
      ✓ should return blockers + warnings instructions for level 2
      ✓ should return all issues instructions for level 3
    getLevelName
      ✓ should return "blockers only" for level 1 (1 ms)
      ✓ should return "blockers + warnings" for level 2
      ✓ should return "all issues" for level 3
    getFixedPrompt
      ✓ should read prompt from prompt.md file and append level 1 instructions by default
      ✓ should append level 2 instructions when level 2 is specified
      ✓ should append level 3 instructions when level 3 is specified
      ✓ should throw error if prompt.md does not exist (6 ms)
    run
      ✓ should run with default max iterations (20) and level 1
      ✓ should use --limit argument when provided
      ✓ should use Infinity when --no-limit is provided
      ✓ should set folder from positional argument (1 ms)
      ✓ should use process.cwd() when no folder provided
      ✓ should ignore --limit when --no-limit is also provided
      ✓ should log start messages with level info
      ✓ should handle folder with --limit option (2 ms)
      ✓ should propagate errors from loopFixes
      ✓ should throw error if prompt.md is missing (1 ms)
      level argument
        ✓ should use level 1 by default
        ✓ should parse --level=1 correctly
        ✓ should parse --level=2 correctly
        ✓ should parse --level=3 correctly
        ✓ should throw error for invalid level
        ✓ should throw error for invalid level 0 (1 ms)
        ✓ should use --blockers-only shortcut
        ✓ should use --no-suggestions shortcut
        ✓ should give --blockers-only precedence over --level
        ✓ should give --no-suggestions precedence over --level
        ✓ should combine level with --limit
        ✓ should combine level with --no-limit
        ✓ should combine level with folder argument
        ✓ should use --no-clear flag to set clearFolder to false
        ✓ should combine --no-clear with other options

PASS src/shared/services/reflection/reflector.test.js
  Reflector
    ✓ aggregates insights until convergence (1 ms)
    ✓ falls back to pattern matcher when extractor yields nothing (1 ms)
    ✓ stops early when quality threshold satisfied

PASS src/shared/services/local-llm/fallbacks/section-extractor.test.js
  section-extractor
    extractSection
      ✓ should extract h2 section by exact name (2 ms)
      ✓ should extract section case-insensitively (1 ms)
      ✓ should extract section with prefix (e.g., "Code Patterns")
      ✓ should extract h3 sections
      ✓ should extract bold-style sections (1 ms)
      ✓ should return empty string for missing section (1 ms)
      ✓ should handle empty input
      ✓ should handle section at end of document
    extractAllSections
      ✓ should extract all h2 sections
      ✓ should return empty object for no sections (1 ms)
      ✓ should handle empty input
    hasSection
      ✓ should return true for existing section
      ✓ should return false for missing section (1 ms)
    extractCodeBlocks
      ✓ should extract code blocks with language
      ✓ should handle code blocks without language
      ✓ should return empty array for no code blocks (1 ms)
      ✓ should handle empty input
    extractListItems
      ✓ should extract bullet points with dash
      ✓ should extract bullet points with asterisk
      ✓ should extract numbered items
      ✓ should extract mixed list types
      ✓ should return empty array for no lists (1 ms)
      ✓ should handle indented list items

PASS src/shared/executors/deep-seek-executor.test.js
  deep-seek-executor
    executeDeepSeek
      ✓ should call runDeepSeek when executorType is not codex (2 ms)
      ○ skipped should delegate to executeCodex when executorType is codex
    runDeepSeek internal functionality
      ✓ should throw error when no prompt provided (8 ms)
      ✓ should create temporary file with prompt text (5 ms)
      ✓ should spawn DeepSeek process with correct command (1 ms)
      ✓ should create log stream with correct path (2 ms)
      ✓ should write log headers with timestamp (1 ms)
      ✓ should handle stdout data processing (2 ms)
      ✓ should handle stderr data (1 ms)
      ✓ should update state manager when taskName provided (2 ms)
      ✓ should suppress streaming logs when UI renderer is active (1 ms)
      ✓ should handle process close with success code (1 ms)
      ✓ should handle process close with error code (1 ms)
      ✓ should handle process error (2 ms)
      ✓ should cleanup temporary file on successful completion (1 ms)
      ✓ should cleanup temporary file on error (1 ms)
      ✓ should handle cleanup error gracefully (2 ms)
      ✓ should implement timeout mechanism
      ✓ should reset timeout on data received
      ✓ should handle long text wrapping (2 ms)
      ✓ should handle empty processed message (2 ms)
    overwriteBlock function
      ✓ should use ANSI escape sequences to move cursor and clear lines

PASS src/commands/task-executor/steps/index.test.js
  steps/index
    module exports
      ✓ should export all step functions (1 ms)
      ✓ should export exactly 9 step functions (1 ms)
      ✓ should export functions with correct types
      ✓ should have all step functions in sequential order
      ✓ should export non-null step functions (1 ms)

PASS src/commands/task-executor/utils/scope-parser.test.js
  scope-parser
    parseTaskScope
      ✓ extracts backend scope
      ✓ extracts frontend scope
      ✓ extracts integration scope
      ✓ returns null when no scope
      ✓ is case insensitive
      ✓ handles mixed case
      ✓ handles scope in middle of content (1 ms)
      ✓ handles whitespace variations
      ✓ returns null for invalid scope value
      ✓ returns null for empty content
    validateScope
      ✓ returns true in single-repo mode without scope
      ✓ returns true in multi-repo mode with scope
      ✓ returns true for frontend scope in multi-repo mode
      ✓ returns true for integration scope in multi-repo mode
      ✓ throws in multi-repo mode without scope (2 ms)
      ✓ error message contains fix instructions (1 ms)
      ✓ returns true in single-repo mode with scope

PASS src/commands/task-executor/steps/step0/index.test.js
  step0
    generateBranchName
      ✓ should generate branch name from task description
      ✓ should limit to first 5 words (1 ms)
      ✓ should remove special characters
      ✓ should convert to lowercase
      ✓ should fallback to task when empty after cleanup
    createBranches
      ✓ should do nothing in single-repo mode
      ✓ should create single branch in monorepo mode
      ✓ should create branches in both repos for separate git mode (1 ms)
      ✓ should switch to existing branch when it already exists (1 ms)
      ✓ should throw error for non-existing-branch errors (7 ms)
    step0
      ✓ should execute successfully with valid task input and existing questions (1 ms)
      ✓ should skip newbranch.txt creation when sameBranch=true
      ✓ should generate clarification questions when they do not exist
      ✓ should create empty answers file when no questions are generated (1 ms)
      ✓ should handle error when answer collection fails
      ✓ should remove PENDING_CLARIFICATION.flag when resuming
      ✓ should exit when task is too short (< 10 characters)
      ✓ should exit when task is empty
      ✓ should exit when task has only whitespace (2 ms)
      ✓ should proceed with exactly 10 characters
      ✓ should handle git hooks verification
      multi-repo integration
        ✓ should call createBranches in multi-repo mode instead of Claude prompt (1 ms)
        ✓ should include branch step in prompt for single-repo mode
        ✓ should skip branch creation entirely when sameBranch=true in multi-repo mode

PASS src/shared/executors/index.test.js
  src/shared/executors/index.js
    getExecutor()
      ✓ should return executeClaude for type "claude" (1 ms)
      ✓ should return executeCodex for type "codex" (1 ms)
      ✓ should return executeGemini for type "gemini"
      ✓ should return executeDeepSeek for type "deep-seek" (1 ms)
      ✓ should return executeGlm for type "glm"
      ✓ should throw error for unknown executor type (4 ms)
      ✓ should throw error with specific type name
      ✓ should throw error for empty string
      ✓ should throw error for undefined (1 ms)
      ✓ should throw error for null
    direct exports
      ✓ should export executeClaude directly
      ✓ should export executeCodex directly (3 ms)
      ✓ should export executeGemini directly
      ✓ should export executeDeepSeek directly
      ✓ should export executeGlm directly
    exports
      ✓ should export getExecutor function
      ✓ should export all executor functions (1 ms)

PASS src/commands/task-executor/steps/step6/review-code.test.js
  review-code
    file cleanup
      ✓ should remove existing CODE_REVIEW.md file (1 ms)
      ✓ should remove existing GITHUB_PR.md file
      ✓ should not remove files that do not exist
    context file collection
      ✓ should always include AI_PROMPT.md and INITIAL_PROMPT.md (1 ms)
      ✓ should include RESEARCH.md when it exists
      ✓ should include CONTEXT.md when it exists (1 ms)
      ✓ should skip RESEARCH.md and CONTEXT.md from context section when they do not exist (1 ms)
      ✓ should include context files from context-cache service
      ✓ should call context-cache service with current task excluded (1 ms)
      ✓ should include each context file only once in reference list
      ✓ should handle empty task list gracefully
      ✓ should handle directory read errors gracefully
      ✓ should handle statSync errors gracefully
    prompt template loading and replacement
      ✓ should load prompt-review.md template
      ✓ should replace all placeholders in template (1 ms)
      ✓ should include researchSection when RESEARCH.md exists (3 ms)
      ✓ should have empty researchSection when RESEARCH.md does not exist
    executeClaude integration
      ✓ should call executeClaude with built prompt (1 ms)
      ✓ should return executeClaude result
      ✓ should propagate executeClaude errors (10 ms)
    context section building
      ✓ should build context section with consolidated context
      ✓ should always include context summary section
    multi-repo mode
      ✓ should throw error when scope is missing in multi-repo mode (3 ms)
      ✓ should use correct repository path when scope is backend
      ✓ should use correct repository path when scope is frontend

PASS src/shared/executors/gemini-logger.test.js
  Gemini Logger
    processGeminiMessage
      ✓ should return plain text content
      ✓ should skip empty lines
      ✓ should skip whitespace-only lines (1 ms)
      ✓ should skip deprecation warnings
      ✓ should skip help/option output
      ✓ should skip --help output
      ✓ should trim whitespace from valid content
      ✓ should handle multi-line content
      ✓ should handle JSON input as plain text (not parse it) (2 ms)
    Google AI SDK Specific Output Filtering
      ✓ should filter different Node.js deprecation warning codes
      ✓ should handle multiple deprecation warnings in single line
      ✓ should filter command line tool help output variations (1 ms)
      ✓ should filter version information output
      ✓ should filter Google AI API debug messages
      ✓ should filter network retry and timeout messages
      ✓ should filter API key and quota warnings
    Real Gemini Output Patterns
      ✓ should pass through legitimate Gemini responses with code blocks (1 ms)
      ✓ should pass through responses with embedded tool calls
      ✓ should pass through partial streaming responses
      ✓ should pass through error messages from Google AI API
      ✓ should pass through response metadata and timing info
    Unicode and Character Encoding Support
      ✓ should preserve Unicode content in different languages
      ✓ should preserve emoji and special characters
      ✓ should handle special characters and escape sequences
      ✓ should handle multi-byte character sequences
      ✓ should handle mathematical and scientific symbols
    Edge Cases in Line Processing
      ✓ should handle extremely long lines
      ✓ should handle lines with only special characters (1 ms)
      ✓ should handle lines that look like warnings but are legitimate content
      ✓ should handle color codes and ANSI escape sequences
      ✓ should handle malformed UTF-8 sequences gracefully
      ✓ should handle lines with null bytes and control characters
    Integration and Performance Scenarios
      ✓ should handle lines containing both content and system messages
      ✓ should handle multi-line warning patterns that should not be filtered
      ✓ should handle warnings with dynamic content (timestamps, PIDs)
      ✓ should handle high-volume processing without memory leaks (5 ms)
    Robustness and Error Handling
      ✓ should handle non-string input gracefully
      ✓ should handle empty strings and various whitespace combinations
      ✓ should handle input types that are not strings

PASS src/shared/executors/deep-seek-logger.test.js
  DeepSeek Logger
    processDeepSeekMessage
      ✓ should return null for invalid JSON (3 ms)
      ✓ should return null for unknown message type (1 ms)
    Assistant Message Processing
      ✓ should process simple text message
      ✓ should process tool_use with Bash tool
      ✓ should process tool_use with Read tool
      ✓ should process tool_use with Write tool
      ✓ should process tool_use with Edit tool
      ✓ should process tool_use without description
      ✓ should process mixed text and tool_use content
      ✓ should handle empty content array
      ✓ should handle missing message or content
      ✓ should handle multiple tool_use calls
      ✓ should handle unknown tool with default icon
      ✓ should handle text with empty string
      ✓ should handle file paths with directories (1 ms)
      ✓ should handle tool_use with different file operations
    User Message Processing
      ✓ should return null for user messages
      ✓ should return null for tool results
    System Message Processing
      ✓ should handle init subtype
      ✓ should return null for other subtypes
      ✓ should return null for system message without subtype
    Result Message Processing
      ✓ should handle success with duration and cost
      ✓ should handle success without cost
      ✓ should handle error message
      ✓ should handle error without message (1 ms)
      ✓ should handle null cost
      ✓ should handle very small duration
      ✓ should handle very large duration
      ✓ should format cost with 4 decimal places
      ✓ should return null for unknown result subtype
    Tool Icon Mapping
      ✓ should use correct icons for known tools
      ✓ should use default icon for unknown tools
    Complex Scenarios
      ✓ should handle workflow with all tool types
      ✓ should handle empty text blocks correctly
      ✓ should handle complex nested paths correctly
      ✓ should handle mixed message flow
    Error Handling
      ✓ should handle malformed JSON gracefully
      ✓ should handle JSON with missing required properties
    Chinese/Multilingual Support
      ✓ should process Chinese text messages correctly (1 ms)
      ✓ should handle mixed Chinese-English text
      ✓ should handle Chinese characters in tool descriptions
      ✓ should process code with Chinese comments
      ✓ should handle Chinese filenames in tool operations
      ✓ should handle mixed language tool workflows
      ✓ should handle Chinese error messages in results
      ✓ should handle mixed language error context
      ✓ should handle Unicode edge cases in malformed content
    Chinese-Specific Tool Formatting Edge Cases
      ✓ should handle Chinese file paths with directory extraction
      ✓ should handle unknown tools with Chinese names
      ✓ should handle emoji and Chinese character combinations
      ✓ should handle complex Unicode sequences
      ✓ should handle Chinese punctuation and special characters
      ✓ should handle both Traditional and Simplified Chinese (1 ms)
      ✓ should handle Chinese whitespace correctly
    Multilingual Content Processing
      ✓ should handle complex multilingual workflows
      ✓ should handle Chinese characters in complex nested input objects
      ✓ should preserve mixed language formatting integrity
    Encoding and Performance Edge Cases
      ✓ should handle extremely long Chinese text content gracefully
      ✓ should handle Unicode and special characters in Chinese tool descriptions
      ✓ should handle content with mixed language newline characters and whitespace
      ✓ should handle messages with null or undefined multilingual content blocks
    Chinese Model-Specific Error Handling
      ✓ should handle Chinese error messages in system messages
      ✓ should handle result success messages with Chinese cost tracking
      ✓ should handle mixed language error context gracefully
      ✓ should handle Unicode characters in malformed JSON safely

PASS src/shared/services/research-manager/research-indexer.test.js
  research-indexer
    createEmptyIndex
      ✓ should create empty index with correct structure
    getIndexPath
      ✓ should create cache directory if not exists (1 ms)
      ✓ should return correct index file path
    loadResearchIndex
      ✓ should return empty index if file does not exist
      ✓ should load index from file
    saveResearchIndex
      ✓ should write index to file with timestamp (1 ms)
    extractTopics
      ✓ should extract authentication topics
      ✓ should extract multiple topics
      ✓ should return empty array for irrelevant content (1 ms)
      ✓ should not have duplicate topics
    calculateSimilarity
      ✓ should return 1 for identical topics
      ✓ should return 0 for no overlap
      ✓ should return partial similarity for partial overlap
      ✓ should return 0 for empty arrays (1 ms)
    indexResearch
      ✓ should index task research with topics (1 ms)
    findSimilarResearch
      ✓ should return null if no research indexed
      ✓ should find similar research based on topics
      ✓ should return null if similarity below threshold
    getReusableResearch
      ✓ should return null if no similar research (1 ms)
      ✓ should return research with adaptation note if highly similar
    clearResearchIndex
      ✓ should delete index file if exists
      ✓ should do nothing if index does not exist

PASS src/commands/task-executor/steps/step6/curate-insights.test.js
  curate-insights
    ✓ categorizes insights by detected category (1 ms)
    ✓ extracts implementation patterns from markdown content (2 ms)
    ✓ curates insights from reflection data (1 ms)
    ✓ curates insights from TODO content when reflection absent (1 ms)

PASS src/shared/services/local-llm/ollama-client.test.js
  OllamaClient
    constructor
      ✓ should use default values (no default model)
      ✓ should accept custom options
      ✓ should read host from environment variables
    healthCheck
      ✓ should return available: true when server responds (2 ms)
      ✓ should return available: false on connection error
    generate
      ✓ should send correct request (1 ms)
      ✓ should handle empty response
    generateJSON
      ✓ should parse JSON response
      ✓ should extract JSON from text response
      ✓ should throw on invalid JSON (9 ms)
    classify
      ✓ should return filtered topics
      ✓ should return empty array on error
    summarize
      ✓ should return summarized text (1 ms)
    extractSection
      ✓ should extract section content
      ✓ should return empty string for NOT_FOUND
    analyzeDependencies
      ✓ should return dependency analysis
      ✓ should return default on error
    checkCompletion
      ✓ should return completion status
      ✓ should return default on error

PASS src/commands/config/index.test.js
  config command
    CONFIG_FILE and CONFIG_DIR
      ✓ should use user home directory for config
      ✓ should define legacy config path for migration
    ensureConfigDir
      ✓ should create config directory if it does not exist
      ✓ should not create directory if it already exists
    migrateLegacyConfig
      ✓ should migrate legacy config when it exists and new config does not
      ✓ should not migrate if new config already exists (1 ms)
      ✓ should not migrate if legacy config does not exist
      ✓ should handle migration errors gracefully
    CONFIG_SCHEMA
      ✓ should define CLAUDIOMIRO_LOCAL_LLM
      ✓ should define OLLAMA_HOST (1 ms)
      ✓ should define OLLAMA_PORT
      ✓ should define CLAUDIOMIRO_EXECUTOR
    loadConfig
      ✓ should return empty object when file does not exist
      ✓ should return parsed config when file exists
      ✓ should return empty object on parse error
    saveConfig
      ✓ should create config directory and write config as JSON (1 ms)
      ✓ should not recreate directory if it already exists
    applyConfigToEnv
      ✓ should set environment variables from config
      ✓ should skip empty values
      ✓ should convert numbers to strings
    run
      ✓ should display header (1 ms)
      ✓ should handle quick set via args
      ✓ should view configuration
      ✓ should export configuration
      ✓ should reset configuration (1 ms)
      ✓ should not reset if not confirmed
      ✓ should edit configuration
      ✓ should handle Ctrl+C gracefully

PASS src/commands/task-executor/utils/validation.test.js
  validation
    isFullyImplemented
      basic detection
        ✓ should return true for exact match "fully implemented: yes"
        ✓ should return true for "fully implemented: yes" with extra spacing
        ✓ should return true for lowercase "fully implemented: yes"
        ✓ should return true for mixed case "Fully Implemented: Yes"
        ✓ should return true for uppercase "FULLY IMPLEMENTED: YES"
        ✓ should return false for "fully implemented: no"
        ✓ should return false for "fully implemented: maybe"
      task list filtering
        ✓ should ignore "fully implemented: yes" inside task items
        ✓ should ignore "fully implemented: yes" in checked task items (1 ms)
        ✓ should detect "fully implemented: yes" that is not part of a task
        ✓ should ignore task items but detect standalone declaration
      first 10 lines limitation
        ✓ should detect "fully implemented: yes" within first 10 lines
        ✓ should not detect "fully implemented: yes" after line 10
        ✓ should check exactly first 10 lines only
        ✓ should handle files with fewer than 10 lines
      edge cases and error handling
        ✓ should handle empty file
        ✓ should handle file with only whitespace
        ✓ should handle file with only newlines
        ✓ should throw error for non-existent file (6 ms)
        ✓ should throw error for file read permission errors
        ✓ should handle very long lines
        ✓ should handle special characters
        ✓ should handle Unicode content
        ✓ should handle emoji in content
        ✓ should handle tabs and special whitespace
        ✓ should handle CRLF line endings
        ✓ should handle mixed line endings (1 ms)
      malformed content
        ✓ should return false for partial match "fully implemented:"
        ✓ should return false for "fully: yes" (2 ms)
        ✓ should return false for "implemented: yes"
        ✓ should handle content without the marker
      multi-line and formatting variations
        ✓ should handle "fully implemented: yes" on first line
        ✓ should handle "fully implemented: yes" on last checked line (line 10)
        ✓ should handle multiple occurrences within first 10 lines
        ✓ should not match text before "fully implemented: yes" on same line (1 ms)
        ✓ should detect with various spacing around colon

PASS src/commands/token-optimizer/index.test.js
  src/commands/token-optimizer/index.js
    extractQuotedValue()
      ✓ should extract double-quoted value (1 ms)
      ✓ should extract single-quoted value
      ✓ should handle values with equals sign
      ✓ should return null for null input
      ✓ should return null for undefined input
      ✓ should return null for argument without equals
      ✓ should handle unquoted value
    printUsage()
      ✓ should print usage information
    run()
      ✓ should show help with --help flag (1 ms)
      ✓ should show help with -h flag
      ✓ should error when command is missing (1 ms)
      ✓ should error when filter is missing
      ✓ should execute token optimizer with valid arguments
      ✓ should pass verbose option when --verbose flag is present
      ✓ should preserve command exit code
      ✓ should handle empty filtered output
      ✓ should not warn when fallback is used without verbose
      ✓ should warn when fallback is used with verbose (1 ms)
      ✓ should handle executor errors
      ✓ should parse single-quoted arguments
    exports
      ✓ should export run function
      ✓ should export printUsage function
      ✓ should export extractQuotedValue function

PASS src/commands/task-executor/steps/step4/analyze-split.test.js
  analyze-split
    analyzeSplit
      ✓ should skip when task is subtask (contains ".") (1 ms)
      ✓ should skip when split.txt already exists
      ✓ should execute analysis and create split.txt when TASK.md exists after execution (1 ms)
      ✓ should execute analysis but skip split.txt creation when task was split (TASK.md does not exist)
      ✓ should verify placeholder replacement in prompt
      ✓ should handle executeClaude failure (4 ms)
      ✓ should throw error when task is null (2 ms)
      ✓ should throw error when task is non-string
      ✓ should execute when task is empty string (passes subtask check)

PASS src/shared/services/local-llm/fallbacks/completion-detector.test.js
  completion-detector
    isFullyImplemented
      ✓ should return true for "Fully implemented: YES" (1 ms)
      ✓ should return true for "Fully implemented: yes" (lowercase)
      ✓ should return true for "Status: Complete"
      ✓ should return true for "Status: Done"
      ✓ should return true for "[x] Fully implemented" checkbox
      ✓ should return false for "Fully implemented: NO"
      ✓ should return false for "Status: Pending" (1 ms)
      ✓ should return false for "Status: In Progress"
      ✓ should return false for empty content
      ✓ should check only first 20 lines for status
    hasApprovedCodeReview
      ✓ should return true for approved status section
      ✓ should return true for LGTM in status (1 ms)
      ✓ should return true for "Verdict: Approved"
      ✓ should return false for rejected status
      ✓ should return false for failed status
      ✓ should return false for empty content
    getCheckboxCompletion
      ✓ should count checked and unchecked boxes (1 ms)
      ✓ should return 100% for all checked
      ✓ should return 0% for none checked
      ✓ should handle no checkboxes
      ✓ should handle empty content
    hasPendingTodos
      ✓ should detect TODO markers (1 ms)
      ✓ should detect FIXME markers
      ✓ should detect unchecked checkboxes
      ✓ should detect "pending" keyword
      ✓ should detect "not implemented" phrase
      ✓ should return false for completed content
      ✓ should handle empty content (1 ms)
    analyzeCompletion
      ✓ should return high confidence for completed task
      ✓ should return low confidence for incomplete task
      ✓ should include reason

PASS src/commands/task-executor/steps/step4/index.test.js
  step4
    step4
      ✓ should orchestrate generateTodo and analyzeSplit successfully
      ✓ should handle TODO validation with errors and continue to analyzeSplit
      ✓ should handle validation with context score of 0 (1 ms)
      ✓ should handle validation with context score of 2
      ✓ should handle validation with multiple errors (1 ms)
      ✓ should propagate error when generateTodo fails (5 ms)
      ✓ should propagate error when analyzeSplit fails (1 ms)
      ✓ should handle empty errors array with invalid validation
      ✓ should work with different task identifiers (1 ms)
      ✓ should handle all valid context scores (0, 1, 2, 3)

PASS src/commands/task-executor/steps/step4/generate-todo.test.js
  generate-todo
    generateTodo
      ✓ should load TODO.md template and call executeClaude with processed prompt (1 ms)
      ✓ should include AI_PROMPT.md in reference files section
      ✓ should use context-cache service to get completed task files
      ✓ should include files returned by context-cache service (1 ms)
      ✓ should use context-cache service (which excludes standard files internally)
      ✓ should inject curated insights when available
      ✓ should replace all placeholders in prompt template
      ✓ should handle empty context when no previous TASK folders exist
      ✓ should only include files from completed tasks (via context-cache) (1 ms)
      ✓ should handle error when TODO.md template is missing (6 ms)
      ✓ should handle error when prompt template is missing
      ✓ should pass task identifier correctly to executeClaude
      ✓ should include custom files returned by context-cache (excluding standard files) (2 ms)
      multi-repo mode
        ✓ should throw error when scope is missing in multi-repo mode (1 ms)
        ✓ should use correct repository path when scope is backend
        ✓ should use correct repository path when scope is frontend

PASS src/commands/task-executor/steps/step5/research-prompt.test.js
  research-prompt.md template
    ✓ should have "## Code Patterns" section without "Found" suffix (1 ms)
    ✓ should have "## Execution Strategy" section without "Recommendation" suffix
    ✓ should NOT have old "## Code Patterns Found" section name
    ✓ should NOT have old "## Execution Strategy Recommendation" section name
    ✓ should be compatible with context-cache extraction regex
    ✓ should have all required research sections
    ✓ should use language-agnostic file patterns (1 ms)
    ✓ should have placeholder variables

PASS src/commands/task-executor/steps/step5/generate-context.test.js
  generate-context
    generateContextFile
      ✓ should skip if TODO.md does not exist (1 ms)
      ✓ should skip if task is not fully implemented
      ✓ should generate CONTEXT.md when task is fully implemented (1 ms)
      ✓ should extract modified files from TODO.md
      ✓ should include RESEARCH.md strategy if available
      ✓ should handle missing info.json gracefully

PASS src/commands/task-executor/steps/step5/index.test.js
  step5
    step5
      ✓ should execute successfully on first run (1 ms)
      ✓ should trigger reflection when hook requests it
      ✓ should handle re-research after 3+ failed attempts (1 ms)
      ✓ should use context-cache service to collect context from previous tasks
      ✓ should handle executeClaude failure and update info.json with error (9 ms)
      ✓ should remove CODE_REVIEW.md if it exists
      ✓ should handle missing RESEARCH.md in execution context (1 ms)
      ✓ should track execution history in info.json
      ✓ should create new info.json for first run
    scope-aware execution
      ✓ should use state.folder as cwd in single-repo mode (backward compatible) (1 ms)
      ✓ should use state.getRepository(backend) as cwd for @scope backend (1 ms)
      ✓ should use state.getRepository(frontend) as cwd for @scope frontend
      ✓ should use state.getRepository(integration) as cwd for @scope integration (1 ms)
      ✓ should throw validation error when scope missing in multi-repo mode (2 ms)
      ✓ should work when TASK.md does not exist in single-repo mode

PASS src/commands/task-executor/steps/step3/index.test.js
  step3
    No tasks scenario
      ✓ should log info and return early when no tasks found (3 ms)
    Single task scenario (without dependencies)
      ✓ should add empty dependencies to single task without @dependencies (1 ms)
    Single task scenario (with dependencies)
      ✓ should skip single task that already has @dependencies
      ✓ should skip when single task TASK.md does not exist (1 ms)
    Multiple tasks scenario
      ✓ should execute full dependency analysis for multiple tasks (9 ms)
      ✓ should handle missing TASK.md and PROMPT.md files gracefully
    Template processing
      ✓ should replace all placeholders correctly
    Task sorting
      ✓ should sort tasks numerically (TASK2 before TASK10) (1 ms)
    Error handling
      ✓ should handle executeClaude failure gracefully
    File system integration
      ✓ should handle non-directory items in task folder
    Logger integration
      ✓ should call logger methods in correct sequence

PASS src/commands/task-executor/utils/progress-calculator.test.js
  calculateProgress
    Edge Cases
      ✓ returns 0 for zero tasks (empty object)
      ✓ returns 0 for null input (1 ms)
      ✓ returns 0 for undefined input
      ✓ returns 0 for non-object input
    Step-based progress
      ✓ returns 0% when no steps completed
      ✓ counts steps completed for running tasks
      ✓ counts completed tasks as all steps finished
      ✓ counts failed tasks based on the last recorded step
      ✓ returns 100% when every task is completed
      ✓ ignores steps that are not recognised
    Rounding behavior
      ✓ rounds down when fractional part is under .5
      ✓ rounds up when fractional part is .5 or higher (1 ms)
    Pure function behaviour
      ✓ does not modify input object
      ✓ returns same result for repeated calls with same input
    Single task scenarios
      ✓ returns 100% for a completed task
      ✓ returns 67% for a task running Step 4
      ✓ returns 33% for a task at Step 3
      ✓ returns 0% for a task at Step 2
      ✓ returns 0% for a pending task

PASS src/commands/task-executor/steps/step5/generate-research.test.js
  generate-research
    generateResearchFile
      ✓ should skip if RESEARCH.md already exists (2 ms)
      ✓ should skip if TODO.md does not exist (1 ms)
      ✓ should generate RESEARCH.md when TODO.md exists and RESEARCH.md does not (1 ms)
      ✓ should validate RESEARCH.md was created
      ✓ should validate RESEARCH.md has minimum content (1 ms)
      ✓ should warn and continue if research fails

PASS src/commands/task-executor/steps/step4/utils.test.js
  step4/utils
    findTaskFiles
      ✓ should find TASK.md files recursively
      ✓ should return empty array for empty directory
      ✓ should filter out non-directory entries and non-TASK.md files (1 ms)
      ✓ should handle nested directories correctly
      ✓ should handle directory with only TASK.md files
    validateTodoQuality
      ✓ should return error when TODO.md does not exist
      ✓ should return error for content < 500 chars
      ✓ should return error when required sections are missing
      ✓ should return error for insufficient context references (0/3) (1 ms)
      ✓ should return error for insufficient context references (1/3)
      ✓ should return error for insufficient context references (2/3)
      ✓ should return error when no file references with line numbers found
      ✓ should return error when Implementation Plan subsections missing
      ✓ should return valid result with all validation rules passing
      ✓ should calculate contextScore correctly (0) (1 ms)
      ✓ should calculate contextScore correctly (1)
      ✓ should calculate contextScore correctly (2)
      ✓ should calculate contextScore correctly (3)
      ✓ should handle file reference patterns with single line numbers
      ✓ should handle file reference patterns with ranges

PASS src/commands/help/index.test.js
  help command
    run
      ✓ should show help when called without version flags
      ✓ should show version when -v flag is passed (1 ms)
      ✓ should show version when --version flag is passed
      ✓ should show help when --help flag is passed
    showHelp
      ✓ should display header with version (1 ms)
      ✓ should display usage section
      ✓ should display commands section
      ✓ should display global options section
      ✓ should display examples section
      ✓ should display fix-branch level examples (1 ms)
    showVersion
      ✓ should display version in correct format
    COMMANDS constant
      ✓ should have at least 3 commands defined
      ✓ should have name and description for each command (1 ms)
      ✓ should have task-executor command
      ✓ should have fix-command command
      ✓ should have loop-fixes command
      ✓ should have fix-branch command
      ✓ should have fix-branch --level option (1 ms)
      ✓ should have fix-branch --blockers-only option
      ✓ should have fix-branch --no-suggestions option
      ✓ should have test-local-llm command
      ✓ should have test-local-llm --prompt option
      ✓ should have config command
      ✓ should have config KEY=VALUE option
    GLOBAL_OPTIONS constant
      ✓ should have help option
      ✓ should have version option

PASS src/shared/services/context-cache/cache-manager.test.js
  cache-manager
    createEmptyCache
      ✓ should create empty cache with correct structure (1 ms)
    computeFileHash
      ✓ should return null if file does not exist
      ✓ should compute MD5 hash of file content
    getCachePath
      ✓ should create cache directory if not exists
      ✓ should return correct cache file path (1 ms)
    loadCache
      ✓ should return empty cache if file does not exist
      ✓ should load cache from file
      ✓ should return empty cache if version mismatch
      ✓ should return empty cache on parse error
    saveCache
      ✓ should write cache to file with updated timestamp (1 ms)
    hasAiPromptChanged
      ✓ should return true if hash is different
      ✓ should return false if hash is same
    updateAiPromptCache
      ✓ should update AI prompt cache with hash and summary
    getCachedAiPromptSummary
      ✓ should return null if no summary cached
      ✓ should return null if AI_PROMPT changed (3 ms)
      ✓ should return cached summary if valid
    addCompletedTask
      ✓ should add task to completed tasks
    getNewCompletedTasks
      ✓ should return all tasks if afterTask is null (1 ms)
      ✓ should return only tasks after specified task
    getLastProcessedTask
      ✓ should return last processed task from cache
    clearCache
      ✓ should delete cache file if exists
      ✓ should do nothing if cache does not exist
    getAllCompletedTasks
      ✓ should return all completed tasks
    storeCodebasePatterns
      ✓ should merge patterns into cache (1 ms)
    getCodebasePatterns
      ✓ should return stored codebase patterns

PASS src/shared/services/reflection/fallbacks/pattern-matcher.test.js
  pattern-matcher fallback
    ✓ extracts insights using keyword heuristics (1 ms)

PASS src/shared/executors/claude-logger.test.js
  Claude Logger
    Helper Functions - formatToolName
      ✓ should return Bash with tool icon (1 ms)
      ✓ should return Read with tool icon
      ✓ should return Write with tool icon (2 ms)
      ✓ should return Edit with tool icon (1 ms)
      ✓ should return default icon for unknown tool
      ✓ should handle Glob tool with icon
      ✓ should handle Grep tool with icon
      ✓ should handle Task tool with icon
      ✓ should handle TodoWrite tool with icon
      ✓ should handle WebFetch tool with icon
      ✓ should handle WebSearch tool with icon
    Helper Functions - formatToolDescription
      ✓ should format Bash description from input.description (1 ms)
      ✓ should format Read description with filename
      ✓ should format Write description with filename
      ✓ should format Edit description with filename
      ✓ should return empty description for unknown tools
      ✓ should handle Bash without description
      ✓ should handle Read without file_path
      ✓ should handle Write without file_path
      ✓ should handle Edit without file_path
    processAssistantMessage
      ✓ should process text message
      ✓ should process tool_use message
      ✓ should process multiple content blocks
      ✓ should handle empty content array
      ✓ should handle null content
      ✓ should handle missing message
      ✓ should format output with tool icons and descriptions
      ✓ should handle text content with empty string
      ✓ should handle mixed text and tool_use blocks
    processUserMessage
      ✓ should return null for user messages
      ✓ should return null for tool results
    processSystemMessage
      ✓ should handle init subtype
      ✓ should return null for other subtypes
      ✓ should return null for system message without subtype (1 ms)
    processResultMessage
      ✓ should handle success with duration and cost
      ✓ should handle success without cost
      ✓ should handle error message
      ✓ should handle error without message
      ✓ should handle null cost
      ✓ should handle undefined cost
      ✓ should handle very small duration
      ✓ should handle very large duration
      ✓ should format cost with 4 decimal places
      ✓ should return null for unknown result subtype
    processClaudeMessage - Main Entry Point
      ✓ should route to assistant processor
      ✓ should route to user processor
      ✓ should route to system processor
      ✓ should route to result processor (1 ms)
      ✓ should handle JSON parsing errors
      ✓ should handle malformed JSON
      ✓ should handle empty string input
      ✓ should handle unknown message type
      ✓ should handle null input
      ✓ should handle array input
      ✓ should handle string input
      ✓ should handle number input
    Complex Message Scenarios
      ✓ should handle multiple tool uses in single message
      ✓ should handle mixed text and multiple tool_use content (1 ms)
      ✓ should handle real-world message with path formatting
      ✓ should concatenate output strings correctly
      ✓ should handle workflow with all tool types
      ✓ should handle empty text blocks correctly
      ✓ should handle tool_use without description gracefully
      ✓ should handle complex nested paths
      ✓ should handle messages with only tool uses (no text)
    AI-Specific Streaming Scenarios
      ✓ should handle streaming message concatenation with partial chunks
      ✓ should handle complex nested tool workflows with reasoning (1 ms)
      ✓ should handle streaming tool use with dynamic content
    Claude-Specific Response Format Edge Cases
      ✓ should handle tool_use with complex nested input objects
      ✓ should handle WebFetch and WebSearch tools properly
      ✓ should handle unknown tools gracefully with default icon
      ✓ should handle system initialization messages
      ✓ should handle result success messages with duration and cost
      ✓ should handle result success messages with duration only
      ✓ should handle result error messages
      ✓ should handle result error messages without error text
    Error Handling and Edge Cases
      ✓ should handle extremely long text content gracefully
      ✓ should handle messages with null or undefined content blocks
      ✓ should handle tool_use with missing input property
      ✓ should handle content blocks with missing type property
      ✓ should handle malformed JSON gracefully
      ✓ should handle JSON injection attempts safely
      ✓ should handle Unicode and special characters in tool descriptions
      ✓ should handle content with newline characters and various whitespace

PASS src/shared/executors/glm-logger.test.js
  GLM Logger
    processGlmMessage
      ✓ should return null for invalid JSON
      ✓ should return null for unknown message type
    Assistant Message Processing
      ✓ should process simple text message (1 ms)
      ✓ should process tool_use with Bash tool
      ✓ should process tool_use with Read tool
      ✓ should process tool_use with Write tool
      ✓ should process tool_use with Edit tool (1 ms)
      ✓ should process tool_use without description
      ✓ should process mixed text and tool_use content
      ✓ should handle empty content array
      ✓ should handle missing message or content
      ✓ should handle multiple tool_use calls (1 ms)
      ✓ should handle unknown tool with default icon
      ✓ should handle text with empty string
      ✓ should handle file paths with directories
      ✓ should handle tool_use with different file operations
    User Message Processing
      ✓ should return null for user messages
      ✓ should return null for tool results
    System Message Processing
      ✓ should handle init subtype
      ✓ should return null for other subtypes
      ✓ should return null for system message without subtype
    Result Message Processing
      ✓ should handle success with duration and cost (1 ms)
      ✓ should handle success without cost
      ✓ should handle error message
      ✓ should handle error without message
      ✓ should handle null cost
      ✓ should handle very small duration (1 ms)
      ✓ should handle very large duration
      ✓ should format cost with 4 decimal places
      ✓ should return null for unknown result subtype
    Tool Icon Mapping
      ✓ should use correct icons for known tools (1 ms)
      ✓ should use default icon for unknown tools
    Complex Scenarios
      ✓ should handle workflow with all tool types
      ✓ should handle empty text blocks correctly
      ✓ should handle complex nested paths correctly
      ✓ should handle mixed message flow
    Error Handling
      ✓ should handle malformed JSON gracefully
      ✓ should handle JSON with missing required properties
    Chinese Language Model Features
      ✓ should process Chinese text messages correctly
      ✓ should handle mixed Chinese-English text in GLM responses
      ✓ should handle Chinese characters in GLM tool descriptions
      ✓ should process code with Chinese comments for GLM (1 ms)
      ✓ should handle Chinese filenames in GLM tool operations
      ✓ should handle mixed language GLM workflows
      ✓ should handle Chinese error messages in GLM results
      ✓ should handle mixed language error context in GLM
    GLM-Specific Chinese Language Features
      ✓ should handle Chinese file paths with directory extraction
      ✓ should handle unknown tools with Chinese names in GLM
      ✓ should handle emoji and Chinese character combinations in GLM
      ✓ should handle complex Unicode sequences for GLM
      ✓ should handle Chinese punctuation and special characters
      ✓ should handle both Traditional and Simplified Chinese in GLM
      ✓ should handle Chinese whitespace and formatting
    GLM Multilingual Content Processing
      ✓ should handle complex multilingual GLM workflows (1 ms)
      ✓ should handle Chinese characters in complex nested GLM input objects
      ✓ should preserve mixed language formatting integrity for GLM
    GLM-Specific Encoding and Performance Edge Cases
      ✓ should handle extremely long Chinese text content for GLM
      ✓ should handle Unicode and special characters in GLM tool descriptions
      ✓ should handle content with mixed language formatting in GLM
      ✓ should handle GLM-specific model configuration messages (1 ms)
      ✓ should handle GLM response with mixed content types (1 ms)
    GLM Model-Specific Error Handling
      ✓ should handle GLM model-specific error messages
      ✓ should handle GLM token limit errors
      ✓ should handle GLM Chinese text processing errors
      ✓ should handle GLM success messages with Chinese context
      ✓ should handle Unicode characters in malformed GLM JSON safely
      ✓ should handle GLM-specific warning scenarios
    GLM Advanced Multilingual Scenarios
      ✓ should handle GLM code generation with Chinese comments
      ✓ should handle GLM data analysis with Chinese labels (1 ms)
      ✓ should handle GLM documentation generation in Chinese

- Loading...
- Loading...
- Loading...
✔ Done!
- Loading...
✖ Failed!
- Loading...
- First spinner
- Second spinner
PASS src/shared/services/reflection/insight-extractor.test.js
  insight-extractor
    extractInsights
      ✓ parses bullet list with metadata tokens (1 ms)
      ✓ deduplicates insights with higher confidence retained
    categorizeInsight
      ✓ classifies anti-pattern language
      ✓ defaults to projectSpecific when no keywords match (1 ms)

PASS src/shared/utils/logger.test.js
  Logger
    Basic logging methods
      ✓ info() should log info messages (1 ms)
      ✓ success() should log success messages
      ✓ warning() should log warning messages
      ✓ error() should log error messages
    Indentation
      ✓ getIndent() should return empty string initially
      ✓ indent() should increase indentation level
      ✓ outdent() should decrease indentation level
      ✓ outdent() should not go below zero indentation
      ✓ resetIndent() should reset indentation to zero
      ✓ logging methods should respect indentation
      ✓ indented output should have correct format at multiple levels (1 ms)
      ✓ path method should respect indentation
      ✓ command method should respect indentation
      ✓ task method should respect indentation
      ✓ subtask method should respect indentation
      ✓ progress method should respect indentation
    Step logging
      ✓ step() should log task and step information (1 ms)
    Special logging methods
      ✓ task() should log task messages
      ✓ subtask() should log subtask messages
      ✓ path() should log path messages
      ✓ command() should log command messages
    Parallel UI suppression
      ✓ should skip logging when UI renderer is active
      ✓ should allow logging when UI renderer is inactive (1 ms)
    Progress bar
      ✓ createProgressBar() should create progress bar with correct percentage
      ✓ progress() should log progress with percentage (1 ms)
      ✓ progress() should handle 0 total gracefully
      ✓ progress() should show 0% for 0 current (1 ms)
      ✓ progress() should show 100% for completed
      ✓ progress() should calculate percentage accurately
    Utility methods
      ✓ separator() should log separator
      ✓ newline() should log empty line
      ✓ box() should create boxed output with default options (1 ms)
      ✓ box() should create boxed output with custom options (1 ms)
      ✓ clear() should call console.clear
    Spinner methods
      ✓ startSpinner() should create a spinner (1 ms)
      ✓ updateSpinner() should update spinner text
      ✓ succeedSpinner() should stop spinner with success
      ✓ failSpinner() should stop spinner with failure (1 ms)
      ✓ stopSpinner() should stop spinner
      ✓ updateSpinner() should do nothing when spinner is null
      ✓ succeedSpinner() should do nothing when spinner is null
      ✓ failSpinner() should do nothing when spinner is null
      ✓ startSpinner() should stop existing spinner before creating new one
    Ollama status
      ✓ getOllamaStatus() should show suggestion when Ollama not configured (1 ms)
      ✓ getOllamaStatus() should show suggestion when env is empty string
      ✓ getOllamaStatus() should show suggestion when env is "false"
      ✓ getOllamaStatus() should show suggestion when env is "0"
      ✓ getOllamaStatus() should show suggestion when env is "true"
      ✓ getOllamaStatus() should show suggestion when env is "1"
      ✓ getOllamaStatus() should show model name when Ollama is configured
      ✓ getOllamaStatus() should show custom model name
      ✓ banner() should display Ollama status (8 ms)

PASS src/commands/fix-command/index.test.js
  src/commands/fix-command/index.js
    run()
      ✓ should parse --fix-command="npm test" correctly (1 ms)
      ✓ should parse --fix-command with equals sign in command
      ✓ should parse --limit=5 correctly
      ✓ should set maxAttempts to Infinity when --no-limit is passed
      ✓ should default maxAttempts to 20 when no limit flag is provided
      ✓ should default folder to process.cwd() when not provided
      ✓ should extract folder from args correctly
      ✓ should log info about the command being fixed
      ✓ should log "no limit" when --no-limit is passed
      ✓ should handle null fixCommandText gracefully (1 ms)
      ✓ should strip quotes from command text
    exports
      ✓ should export run function

PASS src/commands/task-executor/steps/step2/index.test.js
  step2
    step2 function
      ✓ should execute Claude with replaced prompt in test environment (1 ms)
      ✓ should validate task creation in non-test environment when TASK0 exists
      ✓ should validate task creation in non-test environment when TASK1 exists (TASK0 does not) (1 ms)
      ✓ should throw error when tasks not created in non-test environment (4 ms)
      ✓ should handle executeClaude failure
      ✓ should read prompt.md from correct path
      ✓ should replace claudiomiroFolder placeholder in prompt (1 ms)
      ✓ should skip validation in test environment even when tasks do not exist

Summary of all failing tests
FAIL src/commands/task-executor/steps/step7/index.test.js
  ● step7 › fix-branch Delegation › should call fix-branch with default iterations (20) and level 2

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--limit=20",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      263 |             await step7();
      264 |
    > 265 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      266 |                 '--limit=20',
      267 |                 '--level=2',
      268 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:265:34)

  ● step7 › fix-branch Delegation › should call fix-branch with custom max iterations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--limit=10",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      284 |             await step7(10);
      285 |
    > 286 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      287 |                 '--limit=10',
      288 |                 '--level=2',
      289 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:286:34)

  ● step7 › fix-branch Delegation › should call fix-branch with --no-limit when maxIterations is Infinity

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--no-limit",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      304 |             await step7(Infinity);
      305 |
    > 306 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      307 |                 '--no-limit',
      308 |                 '--level=2',
      309 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:306:34)

  ● step7 › Edge Cases › should use default maxIterations (20) when not provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Array [
        "--limit=20",
    +   "--continue",
        "--level=2",
        "--no-clear",
        "/test",
      ],

    Number of calls: 1

      416 |             await step7(); // No maxIterations provided
      417 |
    > 418 |             expect(runFixBranch).toHaveBeenCalledWith([
          |                                  ^
      419 |                 '--limit=20',
      420 |                 '--level=2',
      421 |                 '--no-clear',

      at Object.toHaveBeenCalledWith (src/commands/task-executor/steps/step7/index.test.js:418:34)

FAIL src/commands/loop-fixes/executor.test.js
  ● src/commands/loop-fixes/executor.js › loopFixes() › should delete CRITICAL_REVIEW_OVERVIEW.md when entering verification mode

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "CRITICAL_REVIEW_OVERVIEW.md"

    Number of calls: 0

      750 |             await loopFixes('Test prompt', 10);
      751 |
    > 752 |             expect(fs.unlinkSync).toHaveBeenCalledWith(expect.stringContaining('CRITICAL_REVIEW_OVERVIEW.md'));
          |                                   ^
      753 |             expect(logger.info).toHaveBeenCalledWith(expect.stringContaining('Starting verification'));
      754 |         });
      755 |     });

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/executor.test.js:752:35)

FAIL src/commands/loop-fixes/index.test.js
  ● src/commands/loop-fixes/index.js › run() › should parse --limit=5 correctly

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test prompt", 5
    Received: "Test prompt", 5, {"freshStart": true}

    Number of calls: 1

      107 |
      108 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: 5)');
    > 109 |             expect(loopFixes).toHaveBeenCalledWith('Test prompt', 5);
          |                               ^
      110 |         });
      111 |
      112 |         test('should default maxIterations to 20 when no limit flag', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:109:31)

  ● src/commands/loop-fixes/index.js › run() › should default maxIterations to 20 when no limit flag

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test prompt", 20
    Received: "Test prompt", 20, {"freshStart": true}

    Number of calls: 1

      116 |
      117 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: 20)');
    > 118 |             expect(loopFixes).toHaveBeenCalledWith('Test prompt', 20);
          |                               ^
      119 |         });
      120 |
      121 |         test('should show "no limit" when --no-limit is passed', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:118:31)

  ● src/commands/loop-fixes/index.js › run() › should show "no limit" when --no-limit is passed

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test prompt", Infinity
    Received: "Test prompt", Infinity, {"freshStart": true}

    Number of calls: 1

      125 |
      126 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: no limit)');
    > 127 |             expect(loopFixes).toHaveBeenCalledWith('Test prompt', Infinity);
          |                               ^
      128 |         });
      129 |
      130 |         test('should set folder from args', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:127:31)

  ● src/commands/loop-fixes/index.js › run() › should handle multiple flags correctly

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Test", Infinity
    Received: "Test", Infinity, {"freshStart": true}

    Number of calls: 1

      152 |             expect(logger.info).toHaveBeenCalledWith('Running loop-fixes (max iterations: no limit)');
      153 |             expect(state.setFolder).toHaveBeenCalledWith('/some/path');
    > 154 |             expect(loopFixes).toHaveBeenCalledWith('Test', Infinity);
          |                               ^
      155 |         });
      156 |
      157 |         test('should call loopFixes with parsed prompt', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:154:31)

  ● src/commands/loop-fixes/index.js › run() › should call loopFixes with parsed prompt

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Check for inconsistencies", 20
    Received: "Check for inconsistencies", 20, {"freshStart": true}

    Number of calls: 1

      160 |             await run(args);
      161 |
    > 162 |             expect(loopFixes).toHaveBeenCalledWith('Check for inconsistencies', 20);
          |                               ^
      163 |         });
      164 |
      165 |         test('should use interactive input when --prompt= is not provided', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:162:31)

  ● src/commands/loop-fixes/index.js › run() › should use interactive input when --prompt= is not provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Interactive user prompt", 20
    Received: "Interactive user prompt", 20, {"freshStart": true}

    Number of calls: 1

      171 |             expect(logger.info).toHaveBeenCalledWith('No --prompt= provided. Please enter your prompt:');
      172 |             expect(getMultilineInput).toHaveBeenCalled();
    > 173 |             expect(loopFixes).toHaveBeenCalledWith('Interactive user prompt', 20);
          |                               ^
      174 |         });
      175 |
      176 |         test('should throw error when no prompt is provided and interactive input is empty', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:173:31)

  ● src/commands/loop-fixes/index.js › run() › should handle prompt with special characters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Check for $pecial & <characters>", 20
    Received: "Check for $pecial & <characters>", 20, {"freshStart": true}

    Number of calls: 1

      195 |             await run(args);
      196 |
    > 197 |             expect(loopFixes).toHaveBeenCalledWith('Check for $pecial & <characters>', 20);
          |                               ^
      198 |         });
      199 |
      200 |         test('should handle prompt with newlines (from shell escaping)', async () => {

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:197:31)

  ● src/commands/loop-fixes/index.js › run() › should handle prompt with newlines (from shell escaping)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Line1\\nLine2", 20
    Received: "Line1\\nLine2", 20, {"freshStart": true}

    Number of calls: 1

      203 |             await run(args);
      204 |
    > 205 |             expect(loopFixes).toHaveBeenCalledWith('Line1\\nLine2', 20);
          |                               ^
      206 |         });
      207 |     });
      208 |

      at Object.toHaveBeenCalledWith (src/commands/loop-fixes/index.test.js:205:31)


Test Suites: 3 failed, 72 passed, 75 total
Tests:       13 failed, 3 skipped, 1954 passed, 1970 total
Snapshots:   0 total
Time:        2.804 s, estimated 12 s
Ran all test suites.
